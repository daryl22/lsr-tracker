<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LSR Tracker</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="root" class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8"></div>

  <script type="text/babel">
    const formatHHMMSS = (hoursDec) => {
      const totalSeconds = Math.max(0, Math.round((Number(hoursDec) || 0) * 3600));
      const hh = Math.floor(totalSeconds / 3600);
      const mm = Math.floor((totalSeconds % 3600) / 60);
      const ss = totalSeconds % 60;
      const hhStr = String(hh).padStart(2, '0');
      const mmStr = String(mm).padStart(2, '0');
      const ssStr = String(ss).padStart(2, '0');
      return `${hhStr}:${mmStr}:${ssStr}`;
    };
    const formatPaceMMSS = (hoursPerKm) => {
      if (hoursPerKm == null || !isFinite(hoursPerKm) || hoursPerKm <= 0) return '';
      const totalSeconds = Math.max(0, Math.round(Number(hoursPerKm) * 3600));
      const mm = Math.floor(totalSeconds / 60);
      const ss = totalSeconds % 60;
      return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    };
    const api = async (path, options = {}) => {
      const res = await fetch(path, {
        credentials: 'include',
        headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
        ...options
      });
      return res.json();
    };

    function useMe() {
      const [me, setMe] = React.useState(null);
      const [loading, setLoading] = React.useState(true);
      React.useEffect(() => {
        api('/api/me').then(d => { setMe(d.user); setLoading(false); });
      }, []);
      return { me, setMe, loading };
    }

    function AuthForms({ onAuthed }) {
      const [isLogin, setIsLogin] = React.useState(true);
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [gender, setGender] = React.useState('male');
      const [error, setError] = React.useState('');

      const submit = async (e) => {
        e.preventDefault();
        setError('');
        const path = isLogin ? '/api/login' : '/api/register';
        const body = isLogin ? { email, password } : { email, password, gender };
        const res = await api(path, { method: 'POST', body: JSON.stringify(body) });
        if (res.ok) onAuthed(); else setError(res.error || 'Error');
      };

      return (
        <div className="max-w-md mx-auto mt-12 bg-white p-6 rounded shadow">
          <h1 className="text-2xl font-semibold mb-4 text-center">{isLogin ? 'Login' : 'Register'}</h1>
          {error && <div className="text-red-600 mb-2">{error}</div>}
          <form onSubmit={submit} className="space-y-3">
            <input className="w-full border rounded p-2" placeholder="Name" value={email} onChange={e => setEmail(e.target.value)} required />
            <input type="password" className="w-full border rounded p-2" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} required />
            {!isLogin && (
              <select 
                className="w-full border rounded p-2" 
                value={gender} 
                onChange={e => setGender(e.target.value)}
                required
              >
                <option value="male">Male</option>
                <option value="female">Female</option>
              </select>
            )}
            <button className="w-full bg-blue-600 text-white rounded p-2">{isLogin ? 'Login' : 'Create Account'}</button>
          </form>
          <button className="w-full mt-3 text-sm text-blue-700" onClick={() => setIsLogin(v => !v)}>
            {isLogin ? 'Need an account? Register' : 'Have an account? Login'}
          </button>
        </div>
      );
    }

    function AdminPanel() {
      const [users, setUsers] = React.useState([]);
      const [entries, setEntries] = React.useState([]);
      const [uploads, setUploads] = React.useState([]);
      const [selectedUserId, setSelectedUserId] = React.useState('');
      const [userPage, setUserPage] = React.useState(1);
      const pageSize = 9;
      const [dateAsc, setDateAsc] = React.useState(false);
      const [pivotExpanded, setPivotExpanded] = React.useState(false);
      const [currentMonth, setCurrentMonth] = React.useState(() => {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      });
      
      // Multiple entries modal state
      const [showMultipleEntriesModal, setShowMultipleEntriesModal] = React.useState(false);
      const [multipleEntriesData, setMultipleEntriesData] = React.useState(null);
      
      // Admin edit modal state
      const [editingEntry, setEditingEntry] = React.useState(null);
      
      // Admin ranking modal state
      const [showAdminRankingModal, setShowAdminRankingModal] = React.useState(false);
      const [adminSelectedEvent, setAdminSelectedEvent] = React.useState(null);
      const [adminRanking, setAdminRanking] = React.useState([]);
      const [adminEventGoal, setAdminEventGoal] = React.useState(0);
      const [editDate, setEditDate] = React.useState('');
      const [editKm, setEditKm] = React.useState('');
      const [editHours, setEditHours] = React.useState('00:00:00');
      const [editTimeHours, setEditTimeHours] = React.useState(0);
      const [editTimeMinutes, setEditTimeMinutes] = React.useState(0);
      const [editTimeSeconds, setEditTimeSeconds] = React.useState(0);
      const [editMsg, setEditMsg] = React.useState('');
      
      // Event management state
      const [events, setEvents] = React.useState([]);
      const [showEventForm, setShowEventForm] = React.useState(false);
      const [eventName, setEventName] = React.useState('');
      const [eventStartDate, setEventStartDate] = React.useState(() => {
        // Set default start date to Philippine time
        const now = new Date();
        const phTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        return phTime.toISOString().split('T')[0];
      });
      const [eventEndDate, setEventEndDate] = React.useState(() => {
        // Set default end date to 7 days from now in Philippine time
        const now = new Date();
        const phTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        const endDate = new Date(phTime.getTime() + (7 * 24 * 60 * 60 * 1000));
        return endDate.toISOString().split('T')[0];
      });
      const [eventCategory, setEventCategory] = React.useState('intermediate');
      const [eventGenderRestriction, setEventGenderRestriction] = React.useState('both');
      const [eventKmGoal, setEventKmGoal] = React.useState('');
      const [eventMsg, setEventMsg] = React.useState('');
      const [editingEvent, setEditingEvent] = React.useState(null);
      
      // Event participation state
      const [showParticipantsModal, setShowParticipantsModal] = React.useState(false);
      const [showRankingModal, setShowRankingModal] = React.useState(false);
      
      // Closed dates management state
      const [showClosedDatesModal, setShowClosedDatesModal] = React.useState(false);
      const [selectedEventForClosedDates, setSelectedEventForClosedDates] = React.useState(null);
      const [closedDates, setClosedDates] = React.useState([]);
      const [newClosedDate, setNewClosedDate] = React.useState('');
      const [closedDatesMsg, setClosedDatesMsg] = React.useState('');
      const [selectedEvent, setSelectedEvent] = React.useState(null);
      
      // Event management tabs state
      const [eventManagementTab, setEventManagementTab] = React.useState('active');
      const [endedEvents, setEndedEvents] = React.useState([]);
      const [participants, setParticipants] = React.useState([]);
      const [ranking, setRanking] = React.useState([]);
      const [eventGoal, setEventGoal] = React.useState(0);
      const loadAll = React.useCallback(() => {
        Promise.all([
          api('/api/admin/users').then(d => d.users || []),
          api(`/api/admin/entries?month=${encodeURIComponent(currentMonth)}`).then(d => d.entries || []),
          api('/api/admin/events').then(d => d.events || [])
        ]).then(([u, e, ev]) => { setUsers(u); setEntries(e); setEvents(ev); setUserPage(1); });
        
        // Load ended events
        loadEndedEvents();
      }, [currentMonth]);
      
      const loadEndedEvents = React.useCallback(async () => {
        try {
          const res = await api('/api/admin/events/ended');
          setEndedEvents(res.events || []);
        } catch (error) {
          console.error('Failed to load ended events:', error);
        }
      }, []);
      React.useEffect(() => { loadAll(); }, [loadAll]);

      const deleteUser = async (id) => {
        const u = users.find(x => x.id === id);
        if (!u) return;
        if (!confirm(`Delete user ${u.email}? This also removes their entries.`)) return;
        const res = await fetch(`/api/admin/users/${id}`, { method: 'DELETE', credentials: 'include' });
        const json = await res.json();
        if (json.ok) loadAll();
      };

      const openEditModal = (entry) => {
        setEditingEntry(entry);
        setEditDate(entry.date);
        setEditKm(entry.km.toString());
        // Convert decimal hours back to HH:MM:SS format for editing
        const formatHoursToTime = (hoursDec) => {
          const totalSeconds = Math.max(0, Math.round((Number(hoursDec) || 0) * 3600));
          const hh = Math.floor(totalSeconds / 3600);
          const mm = Math.floor((totalSeconds % 3600) / 60);
          const ss = totalSeconds % 60;
          return `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}:${String(ss).padStart(2, '0')}`;
        };
        const timeString = formatHoursToTime(entry.hours);
        setEditHours(timeString);
        // Parse the time string to set dropdown values
        const timeParts = timeString.split(':');
        setEditTimeHours(parseInt(timeParts[0]) || 0);
        setEditTimeMinutes(parseInt(timeParts[1]) || 0);
        setEditTimeSeconds(parseInt(timeParts[2]) || 0);
        setEditMsg('');
      };

      const closeEditModal = () => {
        setEditingEntry(null);
        setEditDate('');
        setEditKm('');
        setEditHours('00:00:00');
        setEditTimeHours(0);
        setEditTimeMinutes(0);
        setEditTimeSeconds(0);
        setEditMsg('');
      };

      const updateAdminEntry = async (e) => {
        e.preventDefault();
        
        // For edit modals, we allow any time (including 0:0:0 if user wants to clear the time)
        // No validation needed for edit modals
        
        if (!confirm('Have you verified that the information you entered is accurate?')) return;
        
        const toHours = (t) => {
          if (t == null || t === '') return 0;
          if (typeof t === 'number') return t;
          if (typeof t !== 'string') return Number(t) || 0;
          if (!t.includes(':')) return Number(t) || 0;
          const parts = t.split(':').map(x => x.trim());
          const hh = Number(parts[0]) || 0;
          const mm = Number(parts[1] || 0) || 0;
          const ss = Number(parts[2] || 0) || 0;
          return hh + (mm / 60) + (ss / 3600);
        };
        
        const hoursDec = toHours(editHours);
        const kmNum = Number(editKm) || 0;
        const paceNum = kmNum > 0 && hoursDec > 0 ? hoursDec / kmNum : null;
        
        const res = await api(`/api/admin/entries/${editingEntry.id}`, {
          method: 'PUT',
          body: JSON.stringify({
            date: editDate,
            km: kmNum,
            hours: hoursDec,
            pace: paceNum
          })
        });
        
        if (res.ok) {
          closeEditModal();
          loadAll();
        } else {
          setEditMsg(res.error || 'Failed to update entry');
        }
      };

      const deleteAdminEntry = async (entryId) => {
        if (!confirm('Are you sure you want to delete this entry?')) return;
        
        const res = await api(`/api/admin/entries/${entryId}`, { method: 'DELETE' });
        if (res.ok) {
          loadAll();
        } else {
          alert(res.error || 'Failed to delete entry');
        }
      };

      const navigateMonth = (direction) => {
        const [year, month] = currentMonth.split('-').map(Number);
        const date = new Date(year, month - 1, 1); // month is 0-based in Date constructor
        
        if (direction === 'prev') {
          date.setMonth(date.getMonth() - 1);
        } else {
          date.setMonth(date.getMonth() + 1);
        }
        
        const newMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        setCurrentMonth(newMonth);
      };

      const formatMonthDisplay = (monthStr) => {
        const [year, month] = monthStr.split('-');
        const date = new Date(year, month - 1, 1);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
      };

      // Event management functions
      const createEvent = async (e) => {
        e.preventDefault();
        if (!eventName || !eventStartDate || !eventEndDate || !eventKmGoal) {
          setEventMsg('Please fill in all fields');
          return;
        }
        
        const res = await api('/api/admin/events', {
          method: 'POST',
          body: JSON.stringify({
            name: eventName,
            start_date: eventStartDate,
            end_date: eventEndDate,
            category: eventCategory,
            gender_restriction: eventGenderRestriction,
            km_goal: eventKmGoal
          })
        });
        
        if (res.ok) {
          // Reset form with Philippine time defaults
          const now = new Date();
          const phTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
          const today = phTime.toISOString().split('T')[0];
          const endDate = new Date(phTime.getTime() + (7 * 24 * 60 * 60 * 1000));
          const endDateStr = endDate.toISOString().split('T')[0];
          
          setEventName('');
          setEventStartDate(today);
          setEventEndDate(endDateStr);
          setEventCategory('intermediate');
          setEventGenderRestriction('both');
          setEventKmGoal('');
          setEventMsg('');
          setShowEventForm(false);
          loadAll();
        } else {
          setEventMsg(res.error || 'Failed to create event');
        }
      };

      const openEditEventModal = (event) => {
        setEditingEvent(event);
        setEventName(event.name);
        setEventStartDate(event.start_date);
        setEventEndDate(event.end_date);
        setEventCategory(event.category);
        setEventGenderRestriction(event.gender_restriction);
        setEventKmGoal(event.km_goal || '');
        setEventMsg('');
      };

      const closeEditEventModal = () => {
        setEditingEvent(null);
        // Reset form with Philippine time defaults
        const now = new Date();
        const phTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        const today = phTime.toISOString().split('T')[0];
        const endDate = new Date(phTime.getTime() + (7 * 24 * 60 * 60 * 1000));
        const endDateStr = endDate.toISOString().split('T')[0];
        
        setEventName('');
        setEventStartDate(today);
        setEventEndDate(endDateStr);
        setEventCategory('intermediate');
        setEventGenderRestriction('both');
        setEventKmGoal('');
        setEventMsg('');
      };

      const updateEvent = async (e) => {
        e.preventDefault();
        if (!eventName || !eventStartDate || !eventEndDate || !eventKmGoal) {
          setEventMsg('Please fill in all fields');
          return;
        }
        
        const res = await api(`/api/admin/events/${editingEvent.id}`, {
          method: 'PUT',
          body: JSON.stringify({
            name: eventName,
            start_date: eventStartDate,
            end_date: eventEndDate,
            category: eventCategory,
            gender_restriction: eventGenderRestriction,
            km_goal: eventKmGoal
          })
        });
        
        if (res.ok) {
          closeEditEventModal();
          loadAll();
        } else {
          setEventMsg(res.error || 'Failed to update event');
        }
      };

      const deleteEvent = async (eventId) => {
        if (!confirm('Are you sure you want to delete this event?')) return;
        
        const res = await api(`/api/admin/events/${eventId}`, { method: 'DELETE' });
        if (res.ok) {
          loadAll();
        } else {
          alert(res.error || 'Failed to delete event');
        }
      };
      
      const deleteEndedEvent = async (eventId) => {
        if (!confirm('Are you sure you want to delete this ended event? This will also delete all associated entries and rankings.')) return;
        
        const res = await api(`/api/admin/events/${eventId}`, { method: 'DELETE' });
        if (res.ok) {
          loadEndedEvents();
        } else {
          alert(res.error || 'Failed to delete ended event');
        }
      };

      const endEvent = async (eventId) => {
        if (!confirm('Are you sure you want to end this event? Users will no longer be able to submit entries.')) return;
        const res = await api(`/api/admin/events/${eventId}/end`, { method: 'POST' });
        if (res.ok) {
          alert('Event ended successfully');
          loadAll();
        } else {
          alert(res.error || 'Failed to end event');
        }
      };

      // Event participation functions
      const showParticipants = async (event) => {
        setSelectedEvent(event);
        setShowParticipantsModal(true);
        try {
          const res = await api(`/api/events/${event.id}/participants`);
          setParticipants(res.participants || []);
        } catch (error) {
          console.error('Failed to load participants:', error);
          setParticipants([]);
        }
      };

      const showRanking = async (event) => {
        setSelectedEvent(event);
        setShowRankingModal(true);
        try {
          const res = await api(`/api/events/${event.id}/ranking`);
          setRanking(res.ranking || []);
          setEventGoal(res.goal || 0);
        } catch (error) {
          console.error('Failed to load ranking:', error);
          setRanking([]);
          setEventGoal(0);
        }
      };

      const closeParticipantsModal = () => {
        setShowParticipantsModal(false);
        setSelectedEvent(null);
        setParticipants([]);
      };

      // Admin ranking modal functions
      const showAdminRanking = async (event) => {
        setAdminSelectedEvent(event);
        setShowAdminRankingModal(true);
        try {
          const res = await api(`/api/events/${event.id}/ranking`);
          setAdminRanking(res.ranking || []);
          setAdminEventGoal(res.goal || 0);
        } catch (error) {
          console.error('Failed to load admin ranking:', error);
          setAdminRanking([]);
          setAdminEventGoal(0);
        }
      };

      const closeAdminRankingModal = () => {
        setShowAdminRankingModal(false);
        setAdminSelectedEvent(null);
        setAdminRanking([]);
        setAdminEventGoal(0);
      };






      // Multiple entries modal functions
      const openMultipleEntriesModal = (userId, date) => {
        // Get all admin entries for this user and date
        const userEntries = entries.filter(e => e.user_id === userId && e.date === date);
        const user = userById[userId];
        
        console.log('Opening multiple entries modal:', { userId, date, userEntries, user });
        console.log('All entries:', entries);
        console.log('User by ID:', userById);
        
        const modalData = {
          date,
          user,
          entries: userEntries
        };
        
        console.log('Setting modal data:', modalData);
        setMultipleEntriesData(modalData);
        setShowMultipleEntriesModal(true);
        
        console.log('Modal state set:', { showMultipleEntriesModal: true, multipleEntriesData: modalData });
      };

      const closeMultipleEntriesModal = () => {
        setShowMultipleEntriesModal(false);
        setMultipleEntriesData(null);
      };

      // Closed dates management functions
      const openClosedDatesModal = async (event) => {
        setSelectedEventForClosedDates(event);
        setShowClosedDatesModal(true);
        setClosedDatesMsg('');
        
        // Load existing closed dates
        try {
          const res = await api(`/api/admin/events/${event.id}/closed-dates`);
          if (res.closedDates) {
            setClosedDates(res.closedDates || []);
          } else {
            setClosedDatesMsg('Failed to load closed dates');
          }
        } catch (error) {
          setClosedDatesMsg('Failed to load closed dates');
        }
      };

      const closeClosedDatesModal = () => {
        setShowClosedDatesModal(false);
        setSelectedEventForClosedDates(null);
        setClosedDates([]);
        setNewClosedDate('');
        setClosedDatesMsg('');
      };

      const addClosedDate = async (e) => {
        e.preventDefault();
        if (!newClosedDate) {
          setClosedDatesMsg('Please select a date');
          return;
        }
        
        if (!selectedEventForClosedDates) return;
        
        try {
          const res = await api(`/api/admin/events/${selectedEventForClosedDates.id}/close-date`, {
            method: 'POST',
            body: JSON.stringify({ date: newClosedDate })
          });
          
          if (res.ok) {
            setClosedDatesMsg('');
            setNewClosedDate('');
            // Reload closed dates
            const reloadRes = await api(`/api/admin/events/${selectedEventForClosedDates.id}/closed-dates`);
            if (reloadRes.closedDates) {
              setClosedDates(reloadRes.closedDates || []);
            }
          } else {
            setClosedDatesMsg(res.error || 'Failed to close date');
          }
        } catch (error) {
          setClosedDatesMsg('Failed to close date');
        }
      };

      const removeClosedDate = async (date) => {
        if (!selectedEventForClosedDates) return;
        
        try {
          const res = await api(`/api/admin/events/${selectedEventForClosedDates.id}/close-date`, {
            method: 'DELETE',
            body: JSON.stringify({ date })
          });
          
          if (res.ok) {
            setClosedDatesMsg('');
            // Reload closed dates
            const reloadRes = await api(`/api/admin/events/${selectedEventForClosedDates.id}/closed-dates`);
            if (reloadRes.closedDates) {
              setClosedDates(reloadRes.closedDates || []);
            }
          } else {
            setClosedDatesMsg(res.error || 'Failed to reopen date');
          }
        } catch (error) {
          setClosedDatesMsg('Failed to reopen date');
        }
      };

      const loadUploads = React.useCallback(() => {
        const qs = selectedUserId ? `?user_id=${encodeURIComponent(selectedUserId)}` : '';
        api(`/api/admin/uploads${qs}`).then(d => setUploads(d.uploads || []));
      }, [selectedUserId]);
      React.useEffect(() => { loadUploads(); }, [loadUploads]);

      const userIds = React.useMemo(() => users.map(u => u.id), [users]);
      const totalUserPages = React.useMemo(() => Math.max(1, Math.ceil(users.length / pageSize)), [users.length]);
      const usersPage = React.useMemo(() => {
        const start = (userPage - 1) * pageSize;
        return users.slice(start, start + pageSize);
      }, [users, userPage]);
      const userById = React.useMemo(() => Object.fromEntries(users.map(u => [u.id, u])), [users]);
      const latestImageByUserId = React.useMemo(() => {
        const map = {};
        for (const up of uploads) {
          if (!String(up.mimetype).startsWith('image/')) continue;
          const uid = up.user_id;
          if (!map[uid]) map[uid] = up;
        }
        return map;
      }, [uploads]);
      const byDate = React.useMemo(() => {
        const map = new Map();
        for (const e of entries) {
          if (!map.has(e.date)) map.set(e.date, {});
          map.get(e.date)[e.user_id] = e;
        }
        return map;
      }, [entries]);
      
      // Check for multiple entries per day per user
      const hasMultipleEntriesPerUser = React.useMemo(() => {
        const userEntriesByDate = {};
        for (const e of entries) {
          const key = `${e.user_id}-${e.date}`;
          if (!userEntriesByDate[key]) userEntriesByDate[key] = [];
          userEntriesByDate[key].push(e);
        }
        
        // Find user-date combinations where user has multiple entries
        const multipleEntriesMap = new Map();
        Object.entries(userEntriesByDate).forEach(([key, entries]) => {
          if (entries.length > 1) {
            const [userId, date] = key.split('-');
            multipleEntriesMap.set(key, {
              userId: parseInt(userId),
              date,
              entries
            });
            console.log('Found multiple entries:', { key, userId, date, count: entries.length });
          }
        });
        
        console.log('Multiple entries map:', multipleEntriesMap);
        return multipleEntriesMap;
      }, [entries]);
      const dates = React.useMemo(() => {
        const arr = Array.from(byDate.keys());
        return arr.sort((a,b) => dateAsc ? a.localeCompare(b) : b.localeCompare(a));
      }, [byDate, dateAsc]);

      const totals = React.useMemo(() => {
        const t = {};
        for (const uid of userIds) t[uid] = { km: 0, hours: 0 };
        for (const e of entries) {
          if (!t[e.user_id]) t[e.user_id] = { km: 0, hours: 0 };
          t[e.user_id].km += Number(e.km) || 0;
          t[e.user_id].hours += Number(e.hours) || 0;
        }
        return t;
      }, [entries, userIds]);

      return (
        <div className="space-y-6">
          {/* Event Management Section */}
          <div className="bg-white p-4 rounded shadow">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-medium">Event Management</h3>
            </div>
            
            {/* Tabs */}
            <div className="flex border-b mb-4">
              <button
                onClick={() => setEventManagementTab('active')}
                className={`px-4 py-2 text-sm font-medium ${
                  eventManagementTab === 'active'
                    ? 'border-b-2 border-blue-500 text-blue-600'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                Active Events
              </button>
              <button
                onClick={() => setEventManagementTab('ended')}
                className={`px-4 py-2 text-sm font-medium ${
                  eventManagementTab === 'ended'
                    ? 'border-b-2 border-blue-500 text-blue-600'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                Ended Events
              </button>
            </div>
            
            {/* Active Events Tab */}
            {eventManagementTab === 'active' && (
              <>
                <div className="flex items-center justify-between mb-4">
              <button 
                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                onClick={() => {
                  // Set default dates to Philippine time
                  const now = new Date();
                  const phTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
                  const today = phTime.toISOString().split('T')[0];
                  
                  // Set start date to today, end date to 7 days from now
                  const endDate = new Date(phTime.getTime() + (7 * 24 * 60 * 60 * 1000));
                  const endDateStr = endDate.toISOString().split('T')[0];
                  
                  setEventStartDate(today);
                  setEventEndDate(endDateStr);
                  setEventName('');
                  setEventCategory('intermediate');
                  setEventGenderRestriction('both');
                  setEventKmGoal('');
                  setEventMsg('');
                  setShowEventForm(true);
                }}
              >
                Create New Event
              </button>
            </div>
            
            {/* Events List */}
            <div className="space-y-3">
              {events.filter(event => !event.is_ended).map(event => (
                <div key={event.id} className="border rounded p-3 sm:p-4 bg-gray-50">
                  <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                    <div className="flex-1 min-w-0">
                      <div className="font-semibold text-sm sm:text-base">{event.name}</div>
                      <div className="text-xs sm:text-sm text-gray-600 mt-1">
                        {event.start_date} to {event.end_date}
                      </div>
                      <div className="text-xs sm:text-sm text-gray-600 mt-1">
                        <span className="block sm:inline">Category: {event.category}</span>
                        <span className="hidden sm:inline"> | </span>
                        <span className="block sm:inline">Gender: {event.gender_restriction}</span>
                        <span className="hidden sm:inline"> | </span>
                        <span className="block sm:inline">KM Goal: {event.km_goal} km</span>
                      </div>
                      <div className="text-xs text-gray-500 mt-1">
                        Created by: {event.created_by_email} on {(() => {
                          // Convert database timestamp to Philippine time for display
                          if (event.created_at) {
                            const dbTime = new Date(event.created_at);
                            const phTime = new Date(dbTime.getTime() + (8 * 60 * 60 * 1000));
                            return phTime.toLocaleString('en-US', {
                              timeZone: 'Asia/Manila',
                              year: 'numeric',
                              month: '2-digit',
                              day: '2-digit',
                              hour: '2-digit',
                              minute: '2-digit'
                            });
                          }
                          return event.created_at;
                        })()}
                      </div>
                    </div>
                    <div className="flex flex-wrap sm:flex-nowrap gap-2 sm:ml-4">
                      <button 
                        onClick={() => showParticipants(event)}
                        className="text-xs sm:text-sm bg-green-600 text-white px-2 sm:px-3 py-1 sm:py-2 rounded hover:bg-green-700 whitespace-nowrap"
                      >
                        Participants
                      </button>
                      <button 
                        onClick={() => showAdminRanking(event)}
                        className="text-xs sm:text-sm bg-purple-600 text-white px-2 sm:px-3 py-1 sm:py-2 rounded hover:bg-purple-700 whitespace-nowrap"
                      >
                        Ranking
                      </button>
                      <button 
                        onClick={() => openClosedDatesModal(event)}
                        className="text-xs sm:text-sm bg-red-600 text-white px-2 sm:px-3 py-1 sm:py-2 rounded hover:bg-red-700 whitespace-nowrap"
                      >
                        Manage Closed Dates
                      </button>
                      {(() => {
                        // Get current Philippine time (UTC+8)
                        const now = new Date();
                        const phTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
                        return phTime >= new Date(event.end_date) && !event.is_ended;
                      })() && (
                        <button 
                          onClick={() => endEvent(event.id)}
                          className="text-xs sm:text-sm bg-orange-600 text-white px-2 sm:px-3 py-1 sm:py-2 rounded hover:bg-orange-700 whitespace-nowrap"
                        >
                          End Event
                        </button>
                      )}
                      <button 
                        onClick={() => openEditEventModal(event)}
                        className="text-xs sm:text-sm bg-blue-600 text-white px-2 sm:px-3 py-1 sm:py-2 rounded hover:bg-blue-700 whitespace-nowrap"
                      >
                        Edit
                      </button>
                      <button 
                        onClick={() => deleteEvent(event.id)}
                        className="text-xs sm:text-sm bg-red-600 text-white px-2 sm:px-3 py-1 sm:py-2 rounded hover:bg-red-700 whitespace-nowrap"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                </div>
              ))}
              {events.filter(event => !event.is_ended).length === 0 && (
                <div className="text-gray-500 text-center py-4">No active events found.</div>
              )}
            </div>
                </>
            )}
            
            {/* Ended Events Tab */}
            {eventManagementTab === 'ended' && (
              <div className="space-y-3">
                {endedEvents.map(event => (
                  <div key={event.id} className="border rounded p-3 sm:p-4 bg-gray-50">
                    <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                      <div className="flex-1 min-w-0">
                        <div className="font-semibold text-sm sm:text-base">{event.name}</div>
                        <div className="text-xs sm:text-sm text-gray-600 mt-1">
                          {event.start_date} to {event.end_date}
                        </div>
                        <div className="text-xs sm:text-sm text-gray-600 mt-1">
                          <span className="block sm:inline">Category: {event.category}</span>
                          <span className="hidden sm:inline"> | </span>
                          <span className="block sm:inline">Gender: {event.gender_restriction}</span>
                          <span className="hidden sm:inline"> | </span>
                          <span className="block sm:inline">KM Goal: {event.km_goal} km</span>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          Created by: {event.created_by_email} on {(() => {
                            if (event.created_at) {
                              const dbTime = new Date(event.created_at);
                              const phTime = new Date(dbTime.getTime() + (8 * 60 * 60 * 1000));
                              return phTime.toLocaleString('en-US', {
                                timeZone: 'Asia/Manila',
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                              });
                            }
                            return event.created_at;
                          })()}
                        </div>
                        <div className="text-xs text-red-600 mt-1 font-semibold">
                          ✓ Event Ended
                        </div>
                      </div>
                      <div className="flex flex-wrap sm:flex-nowrap gap-2 sm:ml-4">
                        <button 
                          onClick={() => showAdminRanking(event)}
                          className="text-xs sm:text-sm bg-purple-600 text-white px-2 sm:px-3 py-1 sm:py-2 rounded hover:bg-purple-700 whitespace-nowrap"
                        >
                          View Rankings
                        </button>
                        <button 
                          onClick={() => deleteEndedEvent(event.id)}
                          className="text-xs sm:text-sm bg-red-600 text-white px-2 sm:px-3 py-1 sm:py-2 rounded hover:bg-red-700 whitespace-nowrap"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
                {endedEvents.length === 0 && (
                  <div className="text-gray-500 text-center py-4">No ended events found.</div>
                )}
              </div>
            )}
          </div>

          <div className="bg-white p-4 rounded shadow">
            <h3 className="font-medium mb-3">Top 10 by km (per month)</h3>
            <Top10Monthly />
          </div>

          <div className="bg-white p-4 rounded shadow">
            <h3 className="font-medium mb-2">Users</h3>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
              {usersPage.map(u => {
                const t = totals[u.id] || { km: 0, hours: 0 };
                const pace = t.km > 0 ? formatPaceMMSS((t.hours || 0) / t.km) : '';
                const up = latestImageByUserId[u.id];
                return (
                  <div key={u.id} className="border rounded p-3">
                    <div className="flex items-start justify-between mb-2">
                      <div className="min-w-0">
                        <div className="font-semibold truncate" title={u.email}>{u.email}</div>
                        <div className="text-xs text-gray-500">ID: {u.id}</div>
                      </div>
                      <button className="text-xs bg-red-600 text-white px-2 py-1 rounded" onClick={() => deleteUser(u.id)}>Delete</button>
                    </div>
                    <div className="text-xs text-gray-600">Joined: {(() => {
                      // Convert database timestamp to Philippine time for display
                      if (u.created_at) {
                        const dbTime = new Date(u.created_at);
                        const phTime = new Date(dbTime.getTime() + (8 * 60 * 60 * 1000));
                        return phTime.toLocaleString('en-US', {
                          timeZone: 'Asia/Manila',
                          year: 'numeric',
                          month: '2-digit',
                          day: '2-digit',
                          hour: '2-digit',
                          minute: '2-digit'
                        });
                      }
                      return u.created_at;
                    })()}</div>
                    <div className="text-sm mt-1">Total distance: {Number(t.km || 0).toFixed(2)} km</div>
                  </div>
                );
              })}
              {users.length === 0 && <div className="text-gray-500">No users.</div>}
            </div>
            {users.length > 0 && (
              <div className="flex items-center justify-center gap-3 mt-4">
                <button className="px-3 py-1 border rounded disabled:opacity-50" onClick={() => setUserPage(p => Math.max(1, p - 1))} disabled={userPage <= 1}>Previous</button>
                <span className="text-sm">Page {userPage} of {totalUserPages}</span>
                <button className="px-3 py-1 border rounded disabled:opacity-50" onClick={() => setUserPage(p => Math.min(totalUserPages, p + 1))} disabled={userPage >= totalUserPages}>Next</button>
              </div>
            )}
          </div>

          <div className="bg-white p-4 rounded shadow">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-medium">Entries (pivoted: one column per user)</h3>
              <button className="text-xs border px-2 py-1 rounded" onClick={() => setDateAsc(v => !v)}>
                Sort: {dateAsc ? 'Oldest first' : 'Newest first'}
              </button>
            </div>
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center space-x-2">
                <button 
                  onClick={() => navigateMonth('prev')}
                  className="text-sm border px-3 py-1 rounded hover:bg-gray-50"
                >
                  ← Previous
                </button>
                <span className="text-sm font-medium">{formatMonthDisplay(currentMonth)}</span>
                <button 
                  onClick={() => navigateMonth('next')}
                  className="text-sm border px-3 py-1 rounded hover:bg-gray-50"
                >
                  Next →
                </button>
              </div>
            </div>
            <div className="overflow-auto">
              <table className="min-w-full text-sm border">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="border px-2 py-1 text-left sticky left-0 bg-gray-100">Date</th>
                    {userIds.map((uid, index) => (
                      <th key={uid} className={`border px-2 py-1 text-left min-w-[160px] ${index % 2 === 0 ? 'bg-gray-50' : 'bg-gray-100'}`}>
                        <span className="truncate" title={userById[uid]?.email || ('User ' + uid)}>{userById[uid]?.email || ('User ' + uid)}</span>
                      </th>
                    ))}
                  </tr>
                  <tr>
                    <th className="border px-2 py-1 text-left sticky left-0 bg-gray-100"></th>
                    {userIds.map((uid, index) => (
                      <th key={uid} className={`border px-2 py-1 text-left text-xs text-gray-600 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-gray-100'}`}>Distance | Time</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {(pivotExpanded ? dates : dates.slice(0, 10)).map(d => (
                    <tr key={d}>
                      <td className="border px-2 py-1 sticky left-0 bg-white">{d}</td>
                      {userIds.map((uid, index) => {
                        const e = byDate.get(d)?.[uid];
                        const multipleEntriesKey = `${uid}-${d}`;
                        const hasMultipleEntries = hasMultipleEntriesPerUser.has(multipleEntriesKey);
                        
                        // Debug logging
                        if (hasMultipleEntries) {
                          console.log('Cell has multiple entries:', { uid, date: d, key: multipleEntriesKey });
                        }
                        
                        return (
                          <td key={uid} className={`border px-2 py-1 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-gray-100'}`}>
                            {e ? (() => {
                                if (hasMultipleEntries) {
                                  // Hide details and show View Entries button for multiple entries
                                  const multipleEntriesData = hasMultipleEntriesPerUser.get(multipleEntriesKey);
                                  
                                  return (
                                    <div className="space-y-1">
                                      <div className="text-xs text-orange-600 font-medium">
                                        {multipleEntriesData.entries.length} entries
                                      </div>
                                      <div className="flex space-x-1">
                                        <button 
                                          onClick={() => {
                                            console.log('View Entries button clicked:', { uid, date: d });
                                            openMultipleEntriesModal(uid, d);
                                          }}
                                          className="text-xs bg-orange-500 text-white px-2 py-1 rounded hover:bg-orange-600"
                                          title="Click to view all entries for this user on this date"
                                        >
                                          View Entries
                                        </button>
                                      </div>
                                    </div>
                                  );
                                } else {
                                  // Show single entry details directly in the table
                              const km = Number(e.km) || 0;
                              const hrs = Number(e.hours) || 0;
                              const timeStr = formatHHMMSS(hrs);
                              const rawPace = (typeof e.pace === 'number' ? e.pace : (km > 0 && hrs > 0 ? hrs / km : null));
                              const paceStr = rawPace != null ? formatPaceMMSS(rawPace) : '';
                                  
                              return (
                                <div className="space-y-1">
                                  <div className="text-xs">
                                    {km} km / {timeStr}{paceStr ? ` / pace ${paceStr} min/km` : ''}
                                  </div>
                                  {e.upload_id && (
                                    <div className="text-xs">
                                      <a 
                                        href={`/api/admin/uploads/${e.upload_id}/file`} 
                                        target="_blank" 
                                        rel="noreferrer"
                                        className="text-blue-600 hover:text-blue-800"
                                      >
                                        📷 Screenshot
                                      </a>
                                    </div>
                                  )}
                                  <div className="flex space-x-1">
                                    <button 
                                      onClick={() => openEditModal(e)}
                                      className="text-xs text-blue-600 hover:text-blue-800"
                                    >
                                      Edit
                                    </button>
                                    <button 
                                      onClick={() => deleteAdminEntry(e.id)}
                                      className="text-xs text-red-600 hover:text-red-800"
                                    >
                                      Delete
                                    </button>
                                  </div>
                                </div>
                              );
                                }
                            })() : (
                              <span className="text-gray-400">—</span>
                            )}
                          </td>
                        );
                      })}
                    </tr>
                  ))}
                  {dates.length === 0 && (
                    <tr>
                      <td className="border px-2 py-2 text-center text-gray-500" colSpan={1 + userIds.length}>No entries.</td>
                    </tr>
                  )}
                </tbody>
                <tfoot className="bg-gray-50">
                  <tr>
                    <td className="border px-2 py-1 font-semibold">Totals</td>
                    {userIds.map((uid, index) => {
                      const km = totals[uid]?.km ?? 0;
                      const hrs = totals[uid]?.hours ?? 0;
                      return (
                        <td key={uid} className={`border px-2 py-1 font-semibold ${index % 2 === 0 ? 'bg-gray-50' : 'bg-gray-100'}`}>
                          {Number(km).toFixed(2)} km / {formatHHMMSS(hrs)}
                        </td>
                      );
                    })}
                  </tr>
                </tfoot>
              </table>
              {dates.length > 10 && (
                <div className="flex items-center justify-center mt-3">
                  <button className="text-xs border px-3 py-1 rounded" onClick={() => setPivotExpanded(v => !v)}>
                    {pivotExpanded ? 'Show less' : 'Show more'}
                  </button>
                </div>
              )}
            </div>
          </div>

      


          {/* Admin Edit Entry Modal */}
          {editingEntry && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                <h3 className="text-lg font-semibold mb-4">Edit Entry (Admin)</h3>
                <form onSubmit={updateAdminEntry}>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Date</label>
                      <input
                        type="date"
                        value={editDate}
                        onChange={e => setEditDate(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Distance (km)</label>
                      <input
                        type="number"
                        step="0.01"
                        value={editKm}
                        onChange={e => setEditKm(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Moving time</label>
                      <div className="grid grid-cols-3 gap-2 sm:gap-3">
                        <div className="flex flex-col">
                          <label className="block text-xs text-gray-600 mb-1 text-center">Hours</label>
                          <select 
                            value={editTimeHours} 
                            onChange={e => handleEditTimeHoursChange(e.target.value)}
                            className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                            required
                          >
                            {Array.from({length: 25}, (_, i) => (
                              <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                        <div className="flex flex-col">
                          <label className="block text-xs text-gray-600 mb-1 text-center">Minutes</label>
                          <select 
                            value={editTimeMinutes} 
                            onChange={e => handleEditTimeMinutesChange(e.target.value)}
                            className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                            required
                          >
                            {Array.from({length: 60}, (_, i) => (
                              <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                        <div className="flex flex-col">
                          <label className="block text-xs text-gray-600 mb-1 text-center">Seconds</label>
                          <select 
                            value={editTimeSeconds} 
                            onChange={e => handleEditTimeSecondsChange(e.target.value)}
                            className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                            required
                          >
                            {Array.from({length: 60}, (_, i) => (
                              <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                      </div>
                    </div>
                    {editMsg && (
                      <div className="text-red-600 text-sm">{editMsg}</div>
                    )}
                  </div>
                  <div className="flex justify-end space-x-2 mt-6">
                    <button
                      type="button"
                      onClick={closeEditModal}
                      className="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
                    >
                      Cancel
                    </button>
                    <button
                      type="submit"
                      className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    >
                      Update Entry
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {/* Event Creation Modal */}
          {showEventForm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                <h3 className="text-lg font-semibold mb-4">Create New Event</h3>
                <form onSubmit={createEvent}>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Event Name</label>
                      <input
                        type="text"
                        value={eventName}
                        onChange={e => setEventName(e.target.value)}
                        className="w-full border p-2 rounded"
                        placeholder="Enter event name"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Start Date</label>
                      <input
                        type="date"
                        value={eventStartDate}
                        onChange={e => setEventStartDate(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">End Date</label>
                      <input
                        type="date"
                        value={eventEndDate}
                        onChange={e => setEventEndDate(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Category</label>
                      <select
                        value={eventCategory}
                        onChange={e => setEventCategory(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      >
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Gender Restriction</label>
                      <select
                        value={eventGenderRestriction}
                        onChange={e => setEventGenderRestriction(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      >
                        <option value="both">Both Male and Female</option>
                        <option value="male">Male Only</option>
                        <option value="female">Female Only</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">KM Goal</label>
                      <input
                        type="number"
                        step="0.01"
                        min="0"
                        value={eventKmGoal}
                        onChange={e => setEventKmGoal(e.target.value)}
                        className="w-full border p-2 rounded"
                        placeholder="Enter KM goal (e.g., 100)"
                        required
                      />
                    </div>
                    {eventMsg && (
                      <div className="text-red-600 text-sm">{eventMsg}</div>
                    )}
                  </div>
                  <div className="flex justify-end space-x-2 mt-6">
                    <button
                      type="button"
                      onClick={() => setShowEventForm(false)}
                      className="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
                    >
                      Cancel
                    </button>
                    <button
                      type="submit"
                      className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    >
                      Create Event
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {/* Event Edit Modal */}
          {editingEvent && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                <h3 className="text-lg font-semibold mb-4">Edit Event</h3>
                <form onSubmit={updateEvent}>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Event Name</label>
                      <input
                        type="text"
                        value={eventName}
                        onChange={e => setEventName(e.target.value)}
                        className="w-full border p-2 rounded"
                        placeholder="Enter event name"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Start Date</label>
                      <input
                        type="date"
                        value={eventStartDate}
                        onChange={e => setEventStartDate(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">End Date</label>
                      <input
                        type="date"
                        value={eventEndDate}
                        onChange={e => setEventEndDate(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Category</label>
                      <select
                        value={eventCategory}
                        onChange={e => setEventCategory(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      >
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Gender Restriction</label>
                      <select
                        value={eventGenderRestriction}
                        onChange={e => setEventGenderRestriction(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      >
                        <option value="both">Both Male and Female</option>
                        <option value="male">Male Only</option>
                        <option value="female">Female Only</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">KM Goal</label>
                      <input
                        type="number"
                        step="0.01"
                        min="0"
                        value={eventKmGoal}
                        onChange={e => setEventKmGoal(e.target.value)}
                        className="w-full border p-2 rounded"
                        placeholder="Enter KM goal (e.g., 100)"
                        required
                      />
                    </div>
                    {eventMsg && (
                      <div className="text-red-600 text-sm">{eventMsg}</div>
                    )}
                  </div>
                  <div className="flex justify-end space-x-2 mt-6">
                    <button
                      type="button"
                      onClick={closeEditEventModal}
                      className="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
                    >
                      Cancel
                    </button>
                    <button
                      type="submit"
                      className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    >
                      Update Event
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {/* Participants Modal */}
          {showParticipantsModal && selectedEvent && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold">Participants - {selectedEvent.name}</h3>
                  <button
                    onClick={closeParticipantsModal}
                    className="text-gray-500 hover:text-gray-700 text-xl"
                  >
                    ×
                  </button>
                </div>
                <div className="space-y-3">
                  {participants.map((participant, index) => (
                    <div key={participant.id} className="border rounded p-3 bg-gray-50">
                      <div className="flex items-center justify-between">
                        <div>
                          <div className="font-semibold">{participant.email}</div>
                          <div className="text-sm text-gray-600">
                            Joined: {(() => {
                              // Convert database timestamp to Philippine time for display
                              if (participant.joined_at) {
                                const dbTime = new Date(participant.joined_at);
                                const phTime = new Date(dbTime.getTime() + (8 * 60 * 60 * 1000));
                                return phTime.toLocaleString('en-US', {
                                  timeZone: 'Asia/Manila',
                                  year: 'numeric',
                                  month: '2-digit',
                                  day: '2-digit',
                                  hour: '2-digit',
                                  minute: '2-digit'
                                });
                              }
                              return participant.joined_at;
                            })()}
                          </div>
                        </div>
                        <div className="text-sm text-gray-500">
                          #{index + 1}
                        </div>
                      </div>
                    </div>
                  ))}
                  {participants.length === 0 && (
                    <div className="text-gray-500 text-center py-8">No participants yet.</div>
                  )}
                </div>
                <div className="flex justify-end mt-6">
                  <button
                    onClick={closeParticipantsModal}
                    className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Multiple Entries Modal */}
          {showMultipleEntriesModal && multipleEntriesData && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold">
                    {multipleEntriesData.entries.length > 1 ? 'Multiple' : 'Single'} Entries for {multipleEntriesData.user?.email} on {multipleEntriesData.date} ({multipleEntriesData.entries.length} {multipleEntriesData.entries.length === 1 ? 'entry' : 'entries'})
                  </h3>
                  <button
                    onClick={closeMultipleEntriesModal}
                    className="text-gray-500 hover:text-gray-700"
                  >
                    ✕
                  </button>
                </div>
                
                <div className="space-y-3">
                  {multipleEntriesData.entries.map((entry, index) => {
                    const km = Number(entry.km) || 0;
                    const hrs = Number(entry.hours) || 0;
                    const timeStr = formatHHMMSS(hrs);
                    const rawPace = (typeof entry.pace === 'number' ? entry.pace : (km > 0 && hrs > 0 ? hrs / km : null));
                    const paceStr = rawPace != null ? formatPaceMMSS(rawPace) : '';
                    
                    return (
                      <div key={entry.id} className="bg-gray-50 p-4 rounded border">
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <div className="text-sm font-medium mb-2">
                              Entry #{index + 1}
                            </div>
                            <div className="text-sm text-gray-600 mb-2">
                              {km} km / {timeStr}{paceStr ? ` / pace ${paceStr} min/km` : ''}
                            </div>
                            {entry.upload_id && (
                              <div className="text-xs">
                                <a 
                                  href={`/api/admin/uploads/${entry.upload_id}/file`} 
                                  target="_blank" 
                                  rel="noreferrer"
                                  className="text-blue-600 hover:text-blue-800"
                                >
                                  📷 Screenshot
                                </a>
                              </div>
                            )}
                          </div>
                          <div className="flex space-x-2">
                            <button 
                              onClick={() => {
                                closeMultipleEntriesModal();
                                openEditModal(entry);
                              }}
                              className="text-xs text-blue-600 hover:text-blue-800 bg-blue-50 px-2 py-1 rounded"
                            >
                              Edit
                            </button>
                            <button 
                              onClick={() => {
                                if (confirm('Are you sure you want to delete this entry?')) {
                                  deleteAdminEntry(entry.id);
                                  closeMultipleEntriesModal();
                                }
                              }}
                              className="text-xs text-red-600 hover:text-red-800 bg-red-50 px-2 py-1 rounded"
                            >
                              Delete
                            </button>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
                
                <div className="mt-6 flex justify-end">
                  <button
                    onClick={closeMultipleEntriesModal}
                    className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Closed Dates Management Modal */}
          {showClosedDatesModal && selectedEventForClosedDates && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold">
                    Manage Closed Submission Dates - {selectedEventForClosedDates.name}
                  </h3>
                  <button
                    onClick={closeClosedDatesModal}
                    className="text-gray-500 hover:text-gray-700"
                  >
                    ✕
                  </button>
                </div>
                
                <div className="mb-4">
                  <div className="text-sm text-gray-600 mb-2">
                    Event Period: {selectedEventForClosedDates.start_date} to {selectedEventForClosedDates.end_date}
                  </div>
                  <p className="text-sm text-gray-600">
                    Close specific dates to prevent users from submitting entries for those dates.
                  </p>
                </div>

                {/* Add new closed date form */}
                <form onSubmit={addClosedDate} className="mb-6">
                  <div className="flex gap-2 items-end">
                    <div className="flex-1">
                      <label className="block text-sm font-medium mb-1">Close Date</label>
                      <input
                        type="date"
                        value={newClosedDate}
                        onChange={e => setNewClosedDate(e.target.value)}
                        min={selectedEventForClosedDates.start_date}
                        max={selectedEventForClosedDates.end_date}
                        className="w-full border p-2 rounded"
                        required
                      />
                    </div>
                    <button
                      type="submit"
                      className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
                    >
                      Close Date
                    </button>
                  </div>
                </form>

                {closedDatesMsg && (
                  <div className="text-sm text-red-600 mb-4">{closedDatesMsg}</div>
                )}

                {/* List of closed dates */}
                <div className="space-y-2">
                  <h4 className="font-medium">Closed Dates ({closedDates.length})</h4>
                  {closedDates.length === 0 ? (
                    <div className="text-gray-500 text-sm">No dates are currently closed.</div>
                  ) : (
                    <div className="space-y-2">
                      {closedDates.map(closedDate => (
                        <div key={closedDate.id} className="flex items-center justify-between bg-red-50 border border-red-200 rounded p-3">
                          <div>
                            <div className="font-medium text-red-800">{closedDate.closed_date}</div>
                            <div className="text-xs text-red-600">
                              Closed by {closedDate.closed_by_email} on {new Date(closedDate.created_at).toLocaleDateString()}
                            </div>
                          </div>
                          <button
                            onClick={() => removeClosedDate(closedDate.closed_date)}
                            className="text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700"
                          >
                            Reopen
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                
                <div className="mt-6 flex justify-end">
                  <button
                    onClick={closeClosedDatesModal}
                    className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

        {/* Admin Ranking Modal */}
        {showAdminRankingModal && adminSelectedEvent && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white p-6 rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold">Admin Ranking - {adminSelectedEvent.name}</h3>
                <button
                  onClick={closeAdminRankingModal}
                  className="text-gray-500 hover:text-gray-700 text-xl"
                >
                  ×
                </button>
              </div>
              <div className="mb-4 p-3 bg-blue-50 rounded">
                <div className="text-sm text-blue-800">
                  <strong>Event Goal:</strong> {adminEventGoal} km | 
                  <strong> Period:</strong> {adminSelectedEvent.start_date} to {adminSelectedEvent.end_date}
                </div>
              </div>
              <div className="space-y-2">
                {adminRanking.map((participant, index) => {
                  const progress = adminEventGoal > 0 ? (participant.total_km / adminEventGoal * 100) : 0;
                  const isGoalReached = participant.total_km >= adminEventGoal;
                  return (
                    <div key={participant.id} className={`border rounded p-3 ${isGoalReached ? 'bg-green-50 border-green-200' : 'bg-gray-50'}`}>
                      <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-3">
                          <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold ${
                            index === 0 ? 'bg-yellow-500' : 
                            index === 1 ? 'bg-gray-400' : 
                            index === 2 ? 'bg-orange-600' : 
                            'bg-gray-300'
                          }`}>
                            {index + 1}
                          </div>
                          <div>
                            <div className="font-semibold">{participant.email}</div>
                            <div className="text-sm text-gray-600">
                              {participant.entry_count} entries
                            </div>
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="font-bold text-lg">
                            {Number(participant.total_km).toFixed(2)} km
                          </div>
                          <div className="text-sm text-gray-600">
                            {progress.toFixed(1)}% of goal
                          </div>
                          {isGoalReached && (
                            <div className="text-xs text-green-600 font-semibold">
                              🎯 Goal Reached!
                            </div>
                          )}
                        </div>
                      </div>
                      {adminEventGoal > 0 && (
                        <div className="mt-2">
                          <div className="w-full bg-gray-200 rounded-full h-2">
                            <div 
                              className={`h-2 rounded-full ${isGoalReached ? 'bg-green-500' : 'bg-blue-500'}`}
                              style={{ width: `${Math.min(progress, 100)}%` }}
                            ></div>
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
                {adminRanking.length === 0 && (
                  <div className="text-gray-500 text-center py-8">No participants or no entries yet.</div>
                )}
              </div>
              <div className="flex justify-end mt-6">
                <button
                  onClick={closeAdminRankingModal}
                  className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        )}
        </div>
      );
    }

    function Top10Monthly() {
      const [month, setMonth] = React.useState(() => {
        const d = new Date();
        // Convert to Philippine time (UTC+8)
        const phTime = new Date(d.getTime() + (8 * 60 * 60 * 1000));
        return `${phTime.getUTCFullYear()}-${String(phTime.getUTCMonth()+1).padStart(2,'0')}`;
      });
      const [rows, setRows] = React.useState([]);
      const [loading, setLoading] = React.useState(false);

      const load = React.useCallback(() => {
        setLoading(true);
        api(`/api/admin/top10?month=${encodeURIComponent(month)}`).then(d => {
          setRows(d.top10 || []);
          setLoading(false);
        });
      }, [month]);

      React.useEffect(() => { load(); }, [load]);

      return (
        <div className="space-y-3">
          <div className="flex items-center gap-3">
            <label className="text-sm">Month</label>
            <input type="month" value={month} onChange={e => setMonth(e.target.value)} className="border p-1 rounded" />
            <button className="bg-blue-600 text-white text-sm px-3 py-1 rounded" onClick={load}>Refresh</button>
          </div>
          <div className="overflow-auto">
            <table className="min-w-[360px] text-sm border">
              <thead className="bg-gray-100">
                <tr>
                  <th className="border px-2 py-1 text-left">Rank</th>
                  <th className="border px-2 py-1 text-left">User</th>
                  <th className="border px-2 py-1 text-right">Total km</th>
                </tr>
              </thead>
              <tbody>
                {rows.map((r, i) => (
                  <tr key={r.user_id}>
                    <td className="border px-2 py-1">{i+1}</td>
                    <td className="border px-2 py-1">{r.email}</td>
                    <td className="border px-2 py-1 text-right">{Number(r.total_km).toFixed(2)}</td>
                  </tr>
                ))}
                {!loading && rows.length === 0 && (
                  <tr>
                    <td className="border px-2 py-2 text-center text-gray-500" colSpan={3}>No data</td>
                  </tr>
                )}
                {loading && (
                  <tr>
                    <td className="border px-2 py-2 text-center text-gray-500" colSpan={3}>Loading...</td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    function Dashboard({ onLogout, isAdmin, me }) {
      const [date, setDate] = React.useState(() => {
        // Get current Philippine time (UTC+8)
        const now = new Date();
        const phTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        return phTime.toISOString().slice(0,10);
      });
      const [km, setKm] = React.useState('');
      const [hours, setHours] = React.useState('00:00:00');
      const [timeHours, setTimeHours] = React.useState(0);
      const [timeMinutes, setTimeMinutes] = React.useState(0);
      const [timeSeconds, setTimeSeconds] = React.useState(0);
      
      // Ranking modal state
      const [showRankingModal, setShowRankingModal] = React.useState(false);
      const [selectedEvent, setSelectedEvent] = React.useState(null);
      const [ranking, setRanking] = React.useState([]);
      const [eventGoal, setEventGoal] = React.useState(0);
      
      // Update hours string when dropdown values change
      const updateTimeString = (h, m, s) => {
        const hoursStr = String(h).padStart(2, '0');
        const minutesStr = String(m).padStart(2, '0');
        const secondsStr = String(s).padStart(2, '0');
        return `${hoursStr}:${minutesStr}:${secondsStr}`;
      };
      
      // Handle time dropdown changes
      const handleTimeHoursChange = (value) => {
        const newHours = parseInt(value);
        setTimeHours(newHours);
        setHours(updateTimeString(newHours, timeMinutes, timeSeconds));
      };
      
      const handleTimeMinutesChange = (value) => {
        const newMinutes = parseInt(value);
        setTimeMinutes(newMinutes);
        setHours(updateTimeString(timeHours, newMinutes, timeSeconds));
      };
      
      const handleTimeSecondsChange = (value) => {
        const newSeconds = parseInt(value);
        setTimeSeconds(newSeconds);
        setHours(updateTimeString(timeHours, timeMinutes, newSeconds));
      };

      // Ranking modal functions
      const showRanking = async (event) => {
        setSelectedEvent(event);
        setShowRankingModal(true);
        try {
          const res = await api(`/api/events/${event.id}/ranking`);
          setRanking(res.ranking || []);
          setEventGoal(res.goal || 0);
        } catch (error) {
          console.error('Failed to load ranking:', error);
          setRanking([]);
          setEventGoal(0);
        }
      };

      const closeRankingModal = () => {
        setShowRankingModal(false);
        setSelectedEvent(null);
        setRanking([]);
        setEventGoal(0);
      };
      
      // Edit modal time handlers
      const handleEditTimeHoursChange = (value) => {
        const newHours = parseInt(value);
        setEditTimeHours(newHours);
        setEditHours(updateTimeString(newHours, editTimeMinutes, editTimeSeconds));
      };
      
      const handleEditTimeMinutesChange = (value) => {
        const newMinutes = parseInt(value);
        setEditTimeMinutes(newMinutes);
        setEditHours(updateTimeString(editTimeHours, newMinutes, editTimeSeconds));
      };
      
      const handleEditTimeSecondsChange = (value) => {
        const newSeconds = parseInt(value);
        setEditTimeSeconds(newSeconds);
        setEditHours(updateTimeString(editTimeHours, editTimeMinutes, newSeconds));
      };
      
      // Event entry time handlers
      const handleEventEntryTimeHoursChange = (value) => {
        const newHours = parseInt(value);
        setEventEntryTimeHours(newHours);
        setEventEntryHours(updateTimeString(newHours, eventEntryTimeMinutes, eventEntryTimeSeconds));
      };
      
      const handleEventEntryTimeMinutesChange = (value) => {
        const newMinutes = parseInt(value);
        setEventEntryTimeMinutes(newMinutes);
        setEventEntryHours(updateTimeString(eventEntryTimeHours, newMinutes, eventEntryTimeSeconds));
      };
      
      const handleEventEntryTimeSecondsChange = (value) => {
        const newSeconds = parseInt(value);
        setEventEntryTimeSeconds(newSeconds);
        setEventEntryHours(updateTimeString(eventEntryTimeHours, eventEntryTimeMinutes, newSeconds));
      };
      
      // Event entry edit time handlers
      const handleEditEventEntryTimeHoursChange = (value) => {
        const newHours = parseInt(value);
        setEditEventEntryTimeHours(newHours);
        setEditEventEntryHours(updateTimeString(newHours, editEventEntryTimeMinutes, editEventEntryTimeSeconds));
      };
      
      const handleEditEventEntryTimeMinutesChange = (value) => {
        const newMinutes = parseInt(value);
        setEditEventEntryTimeMinutes(newMinutes);
        setEditEventEntryHours(updateTimeString(editEventEntryTimeHours, newMinutes, editEventEntryTimeSeconds));
      };
      
      const handleEditEventEntryTimeSecondsChange = (value) => {
        const newSeconds = parseInt(value);
        setEditEventEntryTimeSeconds(newSeconds);
        setEditEventEntryHours(updateTimeString(editEventEntryTimeHours, editEventEntryTimeMinutes, newSeconds));
      };
      
      // Validation functions to check if time has been changed from default
      const isTimeChanged = (hours, minutes, seconds) => {
        return hours > 0 || minutes > 0 || seconds > 0;
      };
      
      // For edit modals, we need to check if the time is valid (not all zeros)
      const isEditTimeValid = () => {
        return editTimeHours > 0 || editTimeMinutes > 0 || editTimeSeconds > 0;
      };
      
      const isEditEventEntryTimeValid = () => {
        return editEventEntryTimeHours > 0 || editEventEntryTimeMinutes > 0 || editEventEntryTimeSeconds > 0;
      };
      
      // For edit modals, we also need to check if the time has been modified from the original
      const isEditTimeModified = () => {
        // This will be true if the time is valid (not all zeros)
        return isEditTimeValid();
      };
      
      const isEditEventEntryTimeModified = () => {
        // This will be true if the time is valid (not all zeros)
        return isEditEventEntryTimeValid();
      };
      
      const isMainTimeChanged = () => isTimeChanged(timeHours, timeMinutes, timeSeconds);
      const isEditTimeChanged = () => isTimeChanged(editTimeHours, editTimeMinutes, editTimeSeconds);
      const isEventEntryTimeChanged = () => isTimeChanged(eventEntryTimeHours, eventEntryTimeMinutes, eventEntryTimeSeconds);
      const isEditEventEntryTimeChanged = () => isTimeChanged(editEventEntryTimeHours, editEventEntryTimeMinutes, editEventEntryTimeSeconds);
      
      // Race timer input formatting - auto-advancing cursor behavior
      const formatRaceTime = (value, currentValue = '00:00:00') => {
        // Remove any non-numeric characters
        let cleaned = value.replace(/[^\d]/g, '');
        
        // If input is empty, return default
        if (cleaned === '') return '00:00:00';
        
        // Handle different input lengths with auto-advancing behavior
        if (cleaned.length === 1) {
          // Single digit: "1" -> "01:00:00"
          return '0' + cleaned + ':00:00';
        } else if (cleaned.length === 2) {
          // Two digits: "12" -> "12:00:00"
          return cleaned + ':00:00';
        } else if (cleaned.length === 3) {
          // Three digits: "123" -> "01:23:00"
          return '0' + cleaned.slice(0, 1) + ':' + cleaned.slice(1, 3) + ':00';
        } else if (cleaned.length === 4) {
          // Four digits: "1234" -> "12:34:00"
          return cleaned.slice(0, 2) + ':' + cleaned.slice(2, 4) + ':00';
        } else if (cleaned.length === 5) {
          // Five digits: "12345" -> "01:23:45"
          return '0' + cleaned.slice(0, 1) + ':' + cleaned.slice(1, 3) + ':' + cleaned.slice(3, 5);
        } else if (cleaned.length >= 6) {
          // Six or more digits: "123456" -> "12:34:56"
          return cleaned.slice(0, 2) + ':' + cleaned.slice(2, 4) + ':' + cleaned.slice(4, 6);
        }
        
        return currentValue;
      };
      const [entries, setEntries] = React.useState([]);
      const [uploadMsg, setUploadMsg] = React.useState('');
      const [file, setFile] = React.useState(null);
      const [userDateAsc, setUserDateAsc] = React.useState(false);
      const [currentMonth, setCurrentMonth] = React.useState(() => {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      });
      
      // Edit modal state
      const [editingEntry, setEditingEntry] = React.useState(null);
      const [editDate, setEditDate] = React.useState('');
      const [editKm, setEditKm] = React.useState('');
      const [editHours, setEditHours] = React.useState('00:00:00');
      const [editTimeHours, setEditTimeHours] = React.useState(0);
      const [editTimeMinutes, setEditTimeMinutes] = React.useState(0);
      const [editTimeSeconds, setEditTimeSeconds] = React.useState(0);
      const [editMsg, setEditMsg] = React.useState('');
      
      // Events state
      const [events, setEvents] = React.useState([]);
      const [eventsLoading, setEventsLoading] = React.useState(false);
      const [userEventTab, setUserEventTab] = React.useState('active');
      const [endedEvents, setEndedEvents] = React.useState([]);
      
      // Event entry modal state
      const [showEventEntryModal, setShowEventEntryModal] = React.useState(false);
      const [selectedEventForEntry, setSelectedEventForEntry] = React.useState(null);
      const [eventEntryDate, setEventEntryDate] = React.useState(() => {
        // Get current Philippine time (UTC+8)
        const now = new Date();
        const phTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        return phTime.toISOString().slice(0,10);
      });
      const [eventEntryKm, setEventEntryKm] = React.useState('');
      const [eventEntryHours, setEventEntryHours] = React.useState('00:00:00');
      const [eventEntryTimeHours, setEventEntryTimeHours] = React.useState(0);
      const [eventEntryTimeMinutes, setEventEntryTimeMinutes] = React.useState(0);
      const [eventEntryTimeSeconds, setEventEntryTimeSeconds] = React.useState(0);
      const [eventEntryFile, setEventEntryFile] = React.useState(null);
      const [eventEntryMsg, setEventEntryMsg] = React.useState('');
      
      // Event entries modal state
      const [showEventEntriesModal, setShowEventEntriesModal] = React.useState(false);
      const [selectedEventForEntries, setSelectedEventForEntries] = React.useState(null);
      const [eventEntries, setEventEntries] = React.useState([]);
      const [editingEventEntry, setEditingEventEntry] = React.useState(null);
      const [editEventEntryDate, setEditEventEntryDate] = React.useState('');
      const [editEventEntryKm, setEditEventEntryKm] = React.useState('');
      const [editEventEntryHours, setEditEventEntryHours] = React.useState('00:00:00');
      const [editEventEntryTimeHours, setEditEventEntryTimeHours] = React.useState(0);
      const [editEventEntryTimeMinutes, setEditEventEntryTimeMinutes] = React.useState(0);
      const [editEventEntryTimeSeconds, setEditEventEntryTimeSeconds] = React.useState(0);
      const [editEventEntryMsg, setEditEventEntryMsg] = React.useState('');

      const load = React.useCallback(() => {
        api(`/api/entries?month=${encodeURIComponent(currentMonth)}`).then(d => setEntries(d.entries || []));
      }, [currentMonth]);
      React.useEffect(() => { load(); }, [load]);

      const loadEvents = React.useCallback(async () => {
        if (isAdmin) return; // Don't load events for admin
        setEventsLoading(true);
        try {
          const res = await api('/api/events');
          setEvents(res.events || []);
        } catch (error) {
          console.error('Failed to load events:', error);
          setEvents([]);
        } finally {
          setEventsLoading(false);
        }
      }, [isAdmin]);
      
      const loadUserEndedEvents = React.useCallback(async () => {
        try {
          const res = await api('/api/events/ended');
          setEndedEvents(res.events || []);
        } catch (error) {
          console.error('Failed to load ended events:', error);
          setEndedEvents([]);
        }
      }, []);
      
      React.useEffect(() => { loadEvents(); }, [loadEvents]);
      React.useEffect(() => { 
        if (!isAdmin) {
          loadUserEndedEvents(); 
        }
      }, [loadUserEndedEvents, isAdmin]);

      const joinEvent = async (eventId) => {
        try {
          const res = await api(`/api/events/${eventId}/join`, { method: 'POST' });
          if (res.ok) {
            alert('Successfully joined the event!');
            loadEvents(); // Reload events to update join status
          } else {
            // Show specific error message for gender restrictions
            if (res.error && res.error.includes('exclusive to')) {
              alert(`❌ ${res.error}`);
            } else {
              alert(res.error || 'Failed to join event');
            }
          }
        } catch (error) {
          alert('Failed to join event');
        }
      };

      const openEventEntryModal = (event) => {
        setSelectedEventForEntry(event);
        // Get current Philippine time (UTC+8)
        const now = new Date();
        const phTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        setEventEntryDate(phTime.toISOString().slice(0,10));
        setEventEntryKm('');
        setEventEntryHours('00:00:00');
        setEventEntryTimeHours(0);
        setEventEntryTimeMinutes(0);
        setEventEntryTimeSeconds(0);
        setEventEntryFile(null);
        setEventEntryMsg('');
        setShowEventEntryModal(true);
      };

      const closeEventEntryModal = () => {
        setShowEventEntryModal(false);
        setSelectedEventForEntry(null);
        // Get current Philippine time (UTC+8)
        const now = new Date();
        const phTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        setEventEntryDate(phTime.toISOString().slice(0,10));
        setEventEntryKm('');
        setEventEntryHours('00:00:00');
        setEventEntryTimeHours(0);
        setEventEntryTimeMinutes(0);
        setEventEntryTimeSeconds(0);
        setEventEntryFile(null);
        setEventEntryMsg('');
      };

      const openEventEntriesModal = async (event) => {
        setSelectedEventForEntries(event);
        setShowEventEntriesModal(true);
        
        // Fetch entries for this event
        try {
          const res = await api(`/api/events/${event.id}/entries`);
          if (res.entries) {
            setEventEntries(res.entries);
          } else {
            setEventEntries([]);
          }
        } catch (error) {
          console.error('Failed to load event entries:', error);
          setEventEntries([]);
        }
      };

      const closeEventEntriesModal = () => {
        setShowEventEntriesModal(false);
        setSelectedEventForEntries(null);
        setEventEntries([]);
        setEditingEventEntry(null);
      };

      const openEditEventEntryModal = (entry) => {
        setEditingEventEntry(entry);
        setEditEventEntryDate(entry.date);
        setEditEventEntryKm(String(entry.km));
        
        const formatHoursToTime = (hours) => {
          const totalSeconds = Math.round(Number(hours) * 3600);
          const hh = Math.floor(totalSeconds / 3600);
          const mm = Math.floor((totalSeconds % 3600) / 60);
          const ss = totalSeconds % 60;
          return `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}:${String(ss).padStart(2, '0')}`;
        };
        const timeString = formatHoursToTime(entry.hours);
        setEditEventEntryHours(timeString);
        // Parse the time string to set dropdown values
        const timeParts = timeString.split(':');
        setEditEventEntryTimeHours(parseInt(timeParts[0]) || 0);
        setEditEventEntryTimeMinutes(parseInt(timeParts[1]) || 0);
        setEditEventEntryTimeSeconds(parseInt(timeParts[2]) || 0);
        setEditEventEntryMsg('');
      };

      const closeEditEventEntryModal = () => {
        setEditingEventEntry(null);
        setEditEventEntryDate('');
        setEditEventEntryKm('');
        setEditEventEntryHours('00:00:00');
        setEditEventEntryTimeHours(0);
        setEditEventEntryTimeMinutes(0);
        setEditEventEntryTimeSeconds(0);
        setEditEventEntryMsg('');
      };

      // Test function to force show modal
      const testModal = () => {
        console.log('Testing modal...');
        setMultipleEntriesData({
          date: '2024-01-15',
          user: { email: 'test@example.com' },
          entries: [
            { id: 1, km: 5, hours: 1, upload_id: null },
            { id: 2, km: 7, hours: 1.5, upload_id: null }
          ]
        });
        setShowMultipleEntriesModal(true);
      };

      const updateEventEntry = async (e) => {
        e.preventDefault();
        
        // For edit modals, we allow any time (including 0:0:0 if user wants to clear the time)
        // No validation needed for edit modals
        
        if (!confirm('Have you verified that the information you entered is accurate?')) return;
        
        const toHours = (t) => {
          if (t == null || t === '') return 0;
          if (typeof t === 'number') return t;
          if (typeof t !== 'string') return Number(t) || 0;
          if (!t.includes(':')) return Number(t) || 0;
          const parts = t.split(':').map(x => x.trim());
          const hh = Number(parts[0]) || 0;
          const mm = Number(parts[1] || 0) || 0;
          const ss = Number(parts[2] || 0) || 0;
          return hh + (mm / 60) + (ss / 3600);
        };
        
        const hoursDec = toHours(editEventEntryHours);
        const kmNum = Number(editEventEntryKm) || 0;
        const paceNum = kmNum > 0 && hoursDec > 0 ? hoursDec / kmNum : null;
        
        const res = await api(`/api/entries/${editingEventEntry.id}`, {
          method: 'PUT',
          body: JSON.stringify({
            date: editEventEntryDate,
            km: kmNum,
            hours: hoursDec,
            pace: paceNum
          })
        });
        
        if (res.ok) {
          closeEditEventEntryModal();
          // Reload event entries
          if (selectedEventForEntries) {
            const entriesRes = await api(`/api/events/${selectedEventForEntries.id}/entries`);
            if (entriesRes.entries) {
              setEventEntries(entriesRes.entries);
            }
          }
        } else {
          setEditEventEntryMsg(res.error || 'Failed to update entry');
        }
      };

      const deleteEventEntry = async (entryId) => {
        if (!confirm('Are you sure you want to delete this entry?')) return;
        const res = await api(`/api/entries/${entryId}`, { method: 'DELETE' });
        if (res.ok) {
          // Reload event entries
          if (selectedEventForEntries) {
            const entriesRes = await api(`/api/events/${selectedEventForEntries.id}/entries`);
            if (entriesRes.entries) {
              setEventEntries(entriesRes.entries);
            }
          }
        }
      };

      const submitEventEntry = async (e) => {
        e.preventDefault();
        
        // Check if time has been changed from default
        if (!isEventEntryTimeChanged()) {
          setEventEntryMsg('Please select a time for your run');
          return;
        }
        
        if (!eventEntryKm || !eventEntryHours || !eventEntryFile) {
          setEventEntryMsg('Please fill in all fields and select a screenshot');
          return;
        }
        
        if (!confirm('Have you verified that the information you entered is accurate?')) return;
        
        const toHours = (t) => {
          if (t == null || t === '') return 0;
          if (typeof t === 'number') return t;
          if (typeof t !== 'string') return Number(t) || 0;
          if (!t.includes(':')) return Number(t) || 0;
          const parts = t.split(':').map(x => x.trim());
          const hh = Number(parts[0]) || 0;
          const mm = Number(parts[1] || 0) || 0;
          const ss = Number(parts[2] || 0) || 0;
          return hh + (mm / 60) + (ss / 3600);
        };
        
        const hoursDec = toHours(eventEntryHours);
        const kmNum = Number(eventEntryKm) || 0;
        const paceNum = kmNum > 0 && hoursDec > 0 ? hoursDec / kmNum : null;
        
        const form = new FormData();
        form.append('date', eventEntryDate);
        form.append('km', kmNum);
        form.append('hours', String(hoursDec));
        if (paceNum) form.append('pace', String(paceNum));
        form.append('file', eventEntryFile);
        
        try {
          const res = await fetch(`/api/events/${selectedEventForEntry.id}/entry`, {
            method: 'POST',
            body: form,
            credentials: 'include'
          });
          const result = await res.json();
          
          if (result.ok) {
            closeEventEntryModal();
            load(); // Reload entries
            loadEvents(); // Reload events to update any status
            alert('Entry submitted successfully!');
          } else {
            setEventEntryMsg(result.error || 'Failed to submit entry');
          }
        } catch (error) {
          setEventEntryMsg('Failed to submit entry');
        }
      };

      const submitEntry = async (e) => {
        e.preventDefault();
        
        // Check if time has been changed from default
        if (!isMainTimeChanged()) {
          setUploadMsg('Please select a time for your run');
          return;
        }
        
        if (!confirm('Have you verified that the information you entered is accurate?')) return;
        const toHours = (t) => {
          if (t == null || t === '') return 0;
          if (typeof t === 'number') return t;
          if (typeof t !== 'string') return Number(t) || 0;
          if (!t.includes(':')) return Number(t) || 0;
          const parts = t.split(':').map(x => x.trim());
          const hh = Number(parts[0]) || 0;
          const mm = Number(parts[1] || 0) || 0;
          const ss = Number(parts[2] || 0) || 0;
          return hh + (mm / 60) + (ss / 3600);
        };
        const hoursDec = toHours(hours);
        if (!file) { setUploadMsg('Screenshot is required'); return; }
        const form = new FormData();
        form.append('date', date);
        form.append('km', km);
        form.append('hours', String(hoursDec));
        if (km && hoursDec) {
          const pace = Number(hoursDec) / Number(km);
          form.append('pace', String(pace));
        }
        form.append('file', file);
        const resp = await fetch('/api/entries', { method: 'POST', body: form, credentials: 'include' });
        const res = await resp.json();
        if (res.ok) { 
          setKm(''); 
          setHours('00:00:00'); 
          setTimeHours(0);
          setTimeMinutes(0);
          setTimeSeconds(0);
          setFile(null); 
          setUploadMsg(''); 
          load(); 
        }
        else { setUploadMsg(res.error || 'Failed to save'); }
      };

      const uploadFile = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const form = new FormData();
        form.append('file', file);
        const res = await fetch('/api/uploads', { method: 'POST', body: form, credentials: 'include' });
        const json = await res.json();
        setUploadMsg(json.ok ? 'Uploaded successfully' : (json.error || 'Upload failed'));
      };

      const openEditModal = (entry) => {
        setEditingEntry(entry);
        setEditDate(entry.date);
        setEditKm(entry.km.toString());
        // Convert decimal hours back to HH:MM:SS format for editing
        const formatHoursToTime = (hoursDec) => {
          const totalSeconds = Math.max(0, Math.round((Number(hoursDec) || 0) * 3600));
          const hh = Math.floor(totalSeconds / 3600);
          const mm = Math.floor((totalSeconds % 3600) / 60);
          const ss = totalSeconds % 60;
          return `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}:${String(ss).padStart(2, '0')}`;
        };
        const timeString = formatHoursToTime(entry.hours);
        setEditHours(timeString);
        // Parse the time string to set dropdown values
        const timeParts = timeString.split(':');
        setEditTimeHours(parseInt(timeParts[0]) || 0);
        setEditTimeMinutes(parseInt(timeParts[1]) || 0);
        setEditTimeSeconds(parseInt(timeParts[2]) || 0);
        setEditMsg('');
      };

      const closeEditModal = () => {
        setEditingEntry(null);
        setEditDate('');
        setEditKm('');
        setEditHours('00:00:00');
        setEditTimeHours(0);
        setEditTimeMinutes(0);
        setEditTimeSeconds(0);
        setEditMsg('');
      };

      const updateEntry = async (e) => {
        e.preventDefault();
        
        // For edit modals, we allow any time (including 0:0:0 if user wants to clear the time)
        // No validation needed for edit modals
        
        if (!confirm('Have you verified that the information you entered is accurate?')) return;
        
        const toHours = (t) => {
          if (t == null || t === '') return 0;
          if (typeof t === 'number') return t;
          if (typeof t !== 'string') return Number(t) || 0;
          if (!t.includes(':')) return Number(t) || 0;
          const parts = t.split(':').map(x => x.trim());
          const hh = Number(parts[0]) || 0;
          const mm = Number(parts[1] || 0) || 0;
          const ss = Number(parts[2] || 0) || 0;
          return hh + (mm / 60) + (ss / 3600);
        };
        
        const hoursDec = toHours(editHours);
        const kmNum = Number(editKm) || 0;
        const paceNum = kmNum > 0 && hoursDec > 0 ? hoursDec / kmNum : null;
        
        const res = await api(`/api/entries/${editingEntry.id}`, {
          method: 'PUT',
          body: JSON.stringify({
            date: editDate,
            km: kmNum,
            hours: hoursDec,
            pace: paceNum
          })
        });
        
        if (res.ok) {
          closeEditModal();
          load();
        } else {
          setEditMsg(res.error || 'Failed to update entry');
        }
      };

      const deleteEntry = async (entryId) => {
        if (!confirm('Are you sure you want to delete this entry?')) return;
        
        const res = await api(`/api/entries/${entryId}`, { method: 'DELETE' });
        if (res.ok) {
          load();
        } else {
          alert(res.error || 'Failed to delete entry');
        }
      };

      const navigateMonth = (direction) => {
        const [year, month] = currentMonth.split('-').map(Number);
        const date = new Date(year, month - 1, 1); // month is 0-based in Date constructor
        
        if (direction === 'prev') {
          date.setMonth(date.getMonth() - 1);
        } else {
          date.setMonth(date.getMonth() + 1);
        }
        
        const newMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        setCurrentMonth(newMonth);
      };

      const formatMonthDisplay = (monthStr) => {
        const [year, month] = monthStr.split('-');
        const date = new Date(year, month - 1, 1);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
      };

      return (
        <div className="mt-6 space-y-6">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-semibold">Dashboard</h2>
            <button className="text-sm text-red-600" onClick={onLogout}>Logout</button>
          </div>

          {false && !isAdmin && events.some(event => event.has_joined) && !events.some(event => event.has_joined && new Date() >= new Date(event.start_date) && new Date() <= new Date(event.end_date)) && (
            <div className="bg-white p-4 rounded shadow">
              <form onSubmit={submitEntry} className="grid grid-cols-1 sm:grid-cols-4 gap-3 mb-3">
                <input 
                  type="date" 
                  className="border p-2 rounded" 
                  value={date} 
                  onChange={e => setDate(e.target.value)} 
                  required 
                />
                <input type="number" step="0.01" className="border p-2 rounded" placeholder="Distance (km)" value={km} onChange={e => setKm(e.target.value)} required />
                <div className="grid grid-cols-3 gap-2 sm:gap-3">
                  <div className="flex flex-col">
                    <label className="block text-xs text-gray-600 mb-1 text-center">Hours</label>
                    <select 
                      value={timeHours} 
                      onChange={e => handleTimeHoursChange(e.target.value)}
                      className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                      required
                    >
                      {Array.from({length: 25}, (_, i) => (
                        <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                      ))}
                    </select>
                  </div>
                  <div className="flex flex-col">
                    <label className="block text-xs text-gray-600 mb-1 text-center">Minutes</label>
                    <select 
                      value={timeMinutes} 
                      onChange={e => handleTimeMinutesChange(e.target.value)}
                      className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                      required
                    >
                      {Array.from({length: 60}, (_, i) => (
                        <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                      ))}
                    </select>
                  </div>
                  <div className="flex flex-col">
                    <label className="block text-xs text-gray-600 mb-1 text-center">Seconds</label>
                    <select 
                      value={timeSeconds} 
                      onChange={e => handleTimeSecondsChange(e.target.value)}
                      className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                      required
                    >
                      {Array.from({length: 60}, (_, i) => (
                        <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                      ))}
                    </select>
                  </div>
                </div>
                <button 
                  className={`rounded p-2 ${isMainTimeChanged() ? 'bg-green-600 text-white' : 'bg-gray-400 text-gray-200 cursor-not-allowed'}`}
                  disabled={!isMainTimeChanged()}
                >
                  Save
                </button>
              </form>
              <div>
                <label className="block text-sm font-medium mb-2">Upload screenshot (required)</label>
                <input type="file" accept="image/*" onChange={e => setFile(e.target.files?.[0] || null)} className="block w-full" required />
                {uploadMsg && <div className="text-sm mt-2 text-red-600">{uploadMsg}</div>}
              </div>
            </div>
          )}

          {!isAdmin && events.some(event => {
            // Get current Philippine time (UTC+8)
            const now = new Date();
            const phTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
            const today = phTime.toISOString().split('T')[0];
            return event.has_joined && today >= event.start_date && today <= event.end_date && !event.is_ended;
          }) && (
            <div className="bg-blue-50 border border-blue-200 rounded p-4">
              <div className="text-blue-800 text-center">
                <strong>You are currently participating in an active event!</strong>
                <br />
                <span className="text-sm">Please use the "Submit Entry" button in the events section above to log your runs.</span>
              </div>
            </div>
          )}

          {!isAdmin && !events.some(event => event.has_joined) && (
            <div className="bg-yellow-50 border border-yellow-200 rounded p-4">
              <div className="text-yellow-800 text-center">
                <strong>Join an event to start logging your runs!</strong>
                <br />
                <span className="text-sm">Please join an available event above to begin tracking your running progress.</span>
              </div>
            </div>
          )}


          {!isAdmin && (
            <div className="bg-white p-4 rounded shadow">
              <h3 className="font-medium mb-4">Events</h3>
              
              {/* Tabs */}
              <div className="flex border-b mb-4">
                <button
                  onClick={() => setUserEventTab('active')}
                  className={`px-4 py-2 text-sm font-medium ${
                    userEventTab === 'active'
                      ? 'border-b-2 border-blue-500 text-blue-600'
                      : 'text-gray-500 hover:text-gray-700'
                  }`}
                >
                  Active Events
                </button>
                <button
                  onClick={() => setUserEventTab('ended')}
                  className={`px-4 py-2 text-sm font-medium ${
                    userEventTab === 'ended'
                      ? 'border-b-2 border-blue-500 text-blue-600'
                      : 'text-gray-500 hover:text-gray-700'
                  }`}
                >
                  Ended Events
                </button>
              </div>
              
              {eventsLoading ? (
                <div className="text-center py-4">Loading events...</div>
              ) : (
                <>
                  {/* Active Events Tab */}
                  {userEventTab === 'active' && (
                    <div className="space-y-3">
                      {events.filter(event => !event.is_ended).map(event => {
                    // Get current Philippine time (UTC+8)
                    const now = new Date();
                    const phTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
                    const today = phTime.toISOString().split('T')[0];
                    const isActive = today >= event.start_date && today <= event.end_date && !event.is_ended;
                    const canJoin = isActive && !event.has_joined;
                    const isEligible = event.gender_restriction === 'both' || event.gender_restriction === me?.gender;
                    
                    return (
                      <div key={event.id} className={`border rounded p-3 sm:p-4 ${event.has_joined ? 'bg-green-50 border-green-200' : 'bg-gray-50'}`}>
                        <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                          <div className="flex-1 min-w-0">
                            <div className="font-semibold text-sm sm:text-base">{event.name}</div>
                            <div className="text-xs sm:text-sm text-gray-600 mt-1">
                              {event.start_date} to {event.end_date}
                            </div>
                            <div className="text-xs sm:text-sm text-gray-600 mt-1">
                              <span className="block sm:inline">Category: {event.category}</span>
                              <span className="hidden sm:inline"> | </span>
                              <span className="block sm:inline">Gender: {event.gender_restriction === 'both' ? 'All' : event.gender_restriction === 'male' ? 'Male only' : 'Female only'}</span>
                              <span className="hidden sm:inline"> | </span>
                              <span className="block sm:inline">Goal: {event.km_goal} km</span>
                            </div>
                            {event.has_joined && (
                              <div className="mt-2 space-y-1">
                                <div className="text-xs text-green-600 font-semibold">
                                  ✓ You have joined this event
                                </div>
                              </div>
                            )}
                          </div>
                          <div className="flex sm:flex-col gap-2 sm:ml-4 flex-shrink-0">
                            {event.has_joined && isActive ? (
                              <>
                                <button 
                                  onClick={() => openEventEntryModal(event)}
                                  className="flex-1 sm:flex-none text-xs sm:text-sm bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 whitespace-nowrap"
                                >
                                  Submit Entry
                                </button>
                                <button 
                                  onClick={() => openEventEntriesModal(event)}
                                  className="flex-1 sm:flex-none text-xs sm:text-sm bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 whitespace-nowrap"
                                >
                                  Recent Entries
                                </button>
                              </>
                            ) : event.has_joined && !isActive ? (
                              <button 
                                onClick={() => openEventEntriesModal(event)}
                                className="w-full sm:w-auto text-xs sm:text-sm bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 whitespace-nowrap"
                              >
                                View Entries
                              </button>
                            ) : canJoin && isEligible ? (
                              <button 
                                onClick={() => joinEvent(event.id)}
                                className="w-full sm:w-auto text-xs sm:text-sm bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 whitespace-nowrap"
                              >
                                Join Event
                              </button>
                            ) : !isEligible ? (
                              <span className="text-xs sm:text-sm text-red-600 font-medium">
                                {event.gender_restriction === 'male' ? 'Male only' : 'Female only'}
                              </span>
                            ) : !isActive ? (
                              <span className="text-xs sm:text-sm text-gray-500">Event not active</span>
                            ) : null}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                      {events.filter(event => !event.is_ended).length === 0 && (
                        <div className="text-gray-500 text-center py-4">No active events available.</div>
                      )}
                    </div>
                  )}
                  
                  {/* Ended Events Tab */}
                  {userEventTab === 'ended' && (
                    <div className="space-y-3">
                      {endedEvents.map(event => {
                        const now = new Date();
                        const phTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
                        const today = phTime.toISOString().split('T')[0];
                        const isEligible = event.gender_restriction === 'both' || event.gender_restriction === me?.gender;
                        
                        return (
                          <div key={event.id} className={`border rounded p-3 sm:p-4 ${event.has_joined ? 'bg-green-50 border-green-200' : 'bg-gray-50'}`}>
                            <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                              <div className="flex-1 min-w-0">
                                <div className="font-semibold text-sm sm:text-base">{event.name}</div>
                                <div className="text-xs sm:text-sm text-gray-600 mt-1">
                                  {event.start_date} to {event.end_date}
                                </div>
                                <div className="text-xs sm:text-sm text-gray-600 mt-1">
                                  <span className="block sm:inline">Category: {event.category}</span>
                                  <span className="hidden sm:inline"> | </span>
                                  <span className="block sm:inline">Gender: {event.gender_restriction === 'both' ? 'All' : event.gender_restriction === 'male' ? 'Male only' : 'Female only'}</span>
                                  <span className="hidden sm:inline"> | </span>
                                  <span className="block sm:inline">Goal: {event.km_goal} km</span>
                                </div>
                                <div className="text-xs text-red-600 mt-1 font-semibold">
                                  ✓ Event Ended
                                </div>
                                {event.has_joined && (
                                  <div className="mt-2 space-y-1">
                                    <div className="text-xs text-green-600 font-semibold">
                                      ✓ You participated in this event
                                    </div>
                                  </div>
                                )}
                              </div>
                              <div className="flex sm:flex-col gap-2 sm:ml-4 flex-shrink-0">
                                {event.has_joined || isAdmin ? (
                                  <button 
                                    onClick={() => showRanking(event)}
                                    className="w-full sm:w-auto text-xs sm:text-sm bg-purple-600 text-white px-3 py-2 rounded hover:bg-purple-700 whitespace-nowrap"
                                  >
                                    View Rankings
                                  </button>
                                ) : !isEligible ? (
                                  <span className="text-xs sm:text-sm text-red-600 font-medium">
                                    {event.gender_restriction === 'male' ? 'Male only' : 'Female only'}
                                  </span>
                                ) : (
                                  <span className="text-xs sm:text-sm text-gray-500">You did not participate</span>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      })}
                      {endedEvents.length === 0 && (
                        <div className="text-gray-500 text-center py-4">No ended events found.</div>
                      )}
                    </div>
                  )}
                </>
              )}
            </div>
          )}

          {false && !isAdmin && (
            <div className="bg-white p-4 rounded shadow">
              <div className="flex items-center justify-between mb-2">
                <h3 className="font-medium">Recent entries</h3>
                <div className="flex items-center space-x-2">
                  <button className="text-xs border px-2 py-1 rounded" onClick={() => setUserDateAsc(v => !v)}>
                    Sort: {userDateAsc ? 'Oldest first' : 'Newest first'}
                  </button>
                </div>
              </div>
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center space-x-2">
                  <button 
                    onClick={() => navigateMonth('prev')}
                    className="text-sm border px-3 py-1 rounded hover:bg-gray-50"
                  >
                    ← Previous
                  </button>
                  <span className="text-sm font-medium">{formatMonthDisplay(currentMonth)}</span>
                  <button 
                    onClick={() => navigateMonth('next')}
                    className="text-sm border px-3 py-1 rounded hover:bg-gray-50"
                  >
                    Next →
                  </button>
                </div>
              </div>
              <div className="overflow-auto">
                <table className="min-w-full text-sm border">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="border px-2 py-1 text-left">Date</th>
                      <th className="border px-2 py-1 text-left">Distance (km)</th>
                      <th className="border px-2 py-1 text-left">Moving time</th>
                      <th className="border px-2 py-1 text-left">Pace (min/km)</th>
                      <th className="border px-2 py-1 text-left">Screenshot</th>
                      <th className="border px-2 py-1 text-left">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {[...entries].sort((a,b) => userDateAsc ? String(a.date).localeCompare(String(b.date)) : String(b.date).localeCompare(String(a.date))).map(e => (
                      <tr key={e.id}>
                        <td className="border px-2 py-1">{e.date}</td>
                        <td className="border px-2 py-1">{e.km}</td>
                        <td className="border px-2 py-1">{formatHHMMSS(e.hours)}</td>
                        <td className="border px-2 py-1">{(() => {
                          const km = Number(e.km) || 0;
                          const hrs = Number(e.hours) || 0;
                          if (km > 0 && hrs > 0) return formatPaceMMSS(hrs / km);
                          return '—';
                        })()}</td>
                        <td className="border px-2 py-1">
                          {e.upload_id ? (
                            <a 
                              href={`/api/uploads/${e.upload_id}/file`} 
                              target="_blank" 
                              rel="noreferrer"
                              className="text-blue-600 hover:text-blue-800 text-xs"
                            >
                              View Screenshot
                            </a>
                          ) : (
                            <span className="text-gray-400 text-xs">No screenshot</span>
                          )}
                        </td>
                        <td className="border px-2 py-1">
                          <button 
                            onClick={() => openEditModal(e)}
                            className="text-blue-600 hover:text-blue-800 text-xs mr-2"
                          >
                            Edit
                          </button>
                          <button 
                            onClick={() => deleteEntry(e.id)}
                            className="text-red-600 hover:text-red-800 text-xs"
                          >
                            Delete
                          </button>
                        </td>
                      </tr>
                    ))}
                    {entries.length === 0 && (
                      <tr>
                        <td className="border px-2 py-2 text-center text-gray-500" colSpan={6}>No entries yet.</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {isAdmin && (
            <div className="bg-white p-4 rounded shadow">
              <h3 className="font-medium mb-2">Admin</h3>
              <AdminPanel />
            </div>
          )}

          {/* Ranking Modal */}
          {showRankingModal && selectedEvent && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold">Ranking - {selectedEvent.name}</h3>
                  <button
                    onClick={closeRankingModal}
                    className="text-gray-500 hover:text-gray-700 text-xl"
                  >
                    ×
                  </button>
                </div>
                <div className="mb-4 p-3 bg-blue-50 rounded">
                  <div className="text-sm text-blue-800">
                    <strong>Event Goal:</strong> {eventGoal} km | 
                    <strong> Period:</strong> {selectedEvent.start_date} to {selectedEvent.end_date}
                  </div>
                </div>
                <div className="space-y-2">
                  {ranking.map((participant, index) => {
                    const progress = eventGoal > 0 ? (participant.total_km / eventGoal * 100) : 0;
                    const isGoalReached = participant.total_km >= eventGoal;
                    return (
                      <div key={participant.id} className={`border rounded p-3 ${isGoalReached ? 'bg-green-50 border-green-200' : 'bg-gray-50'}`}>
                        <div className="flex items-center justify-between">
                          <div className="flex items-center space-x-3">
                            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold ${
                              index === 0 ? 'bg-yellow-500' : 
                              index === 1 ? 'bg-gray-400' : 
                              index === 2 ? 'bg-orange-600' : 
                              'bg-gray-300'
                            }`}>
                              {index + 1}
                            </div>
                            <div>
                              <div className="font-semibold">{participant.email}</div>
                              <div className="text-sm text-gray-600">
                                {participant.entry_count} entries
                              </div>
                            </div>
                          </div>
                          <div className="text-right">
                            <div className="font-bold text-lg">
                              {Number(participant.total_km).toFixed(2)} km
                            </div>
                            <div className="text-sm text-gray-600">
                              {progress.toFixed(1)}% of goal
                            </div>
                            {isGoalReached && (
                              <div className="text-xs text-green-600 font-semibold">
                                🎯 Goal Reached!
                              </div>
                            )}
                          </div>
                        </div>
                        {eventGoal > 0 && (
                          <div className="mt-2">
                            <div className="w-full bg-gray-200 rounded-full h-2">
                              <div 
                                className={`h-2 rounded-full ${isGoalReached ? 'bg-green-500' : 'bg-blue-500'}`}
                                style={{ width: `${Math.min(progress, 100)}%` }}
                              ></div>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                  {ranking.length === 0 && (
                    <div className="text-gray-500 text-center py-8">No participants or no entries yet.</div>
                  )}
                </div>
                <div className="flex justify-end mt-6">
                  <button
                    onClick={closeRankingModal}
                    className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Edit Entry Modal */}
          {editingEntry && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                <h3 className="text-lg font-semibold mb-4">Edit Entry</h3>
                <form onSubmit={updateEntry}>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Date</label>
                      <input
                        type="date"
                        value={editDate}
                        onChange={e => setEditDate(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Distance (km)</label>
                      <input
                        type="number"
                        step="0.01"
                        value={editKm}
                        onChange={e => setEditKm(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Moving time</label>
                      <div className="grid grid-cols-3 gap-2 sm:gap-3">
                        <div className="flex flex-col">
                          <label className="block text-xs text-gray-600 mb-1 text-center">Hours</label>
                          <select 
                            value={editTimeHours} 
                            onChange={e => handleEditTimeHoursChange(e.target.value)}
                            className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                            required
                          >
                            {Array.from({length: 25}, (_, i) => (
                              <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                        <div className="flex flex-col">
                          <label className="block text-xs text-gray-600 mb-1 text-center">Minutes</label>
                          <select 
                            value={editTimeMinutes} 
                            onChange={e => handleEditTimeMinutesChange(e.target.value)}
                            className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                            required
                          >
                            {Array.from({length: 60}, (_, i) => (
                              <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                        <div className="flex flex-col">
                          <label className="block text-xs text-gray-600 mb-1 text-center">Seconds</label>
                          <select 
                            value={editTimeSeconds} 
                            onChange={e => handleEditTimeSecondsChange(e.target.value)}
                            className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                            required
                          >
                            {Array.from({length: 60}, (_, i) => (
                              <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                      </div>
                    </div>
                    {editMsg && (
                      <div className="text-red-600 text-sm">{editMsg}</div>
                    )}
                  </div>
                  <div className="flex justify-end space-x-2 mt-6">
                    <button
                      type="button"
                      onClick={closeEditModal}
                      className="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
                    >
                      Cancel
                    </button>
                    <button
                      type="submit"
                      className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    >
                      Update Entry
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {/* Event Recent Entries Modal */}
          {showEventEntriesModal && selectedEventForEntries && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <h3 className="text-lg font-semibold mb-4">Recent Entries - {selectedEventForEntries.name}</h3>
                <div className="space-y-3">
                  {eventEntries.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      No entries yet for this event. Submit your first entry!
                    </div>
                  ) : (
                    eventEntries.map(entry => {
                      const km = Number(entry.km) || 0;
                      const hrs = Number(entry.hours) || 0;
                      const timeStr = formatHHMMSS(hrs);
                      const paceStr = entry.pace != null ? formatPaceMMSS(entry.pace) : '';
                      
                      return (
                        <div key={entry.id} className="border rounded p-3 bg-gray-50">
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <div className="font-semibold text-sm">{entry.date}</div>
                              <div className="text-sm text-gray-600">
                                {km} km / {timeStr}{paceStr ? ` / pace ${paceStr} min/km` : ''}
                              </div>
                            </div>
                            <div className="flex gap-2">
                              {entry.upload_id && (
                                <a 
                                  href={`/api/uploads/${entry.upload_id}/file`} 
                                  target="_blank" 
                                  rel="noopener noreferrer"
                                  className="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700"
                                >
                                  View
                                </a>
                              )}
                              <button 
                                onClick={() => openEditEventEntryModal(entry)}
                                className="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700"
                              >
                                Edit
                              </button>
                              <button 
                                onClick={() => deleteEventEntry(entry.id)}
                                className="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700"
                              >
                                Delete
                              </button>
                            </div>
                          </div>
                        </div>
                      );
                    })
                  )}
                </div>
                <div className="flex justify-end mt-6">
                  <button
                    onClick={closeEventEntriesModal}
                    className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Edit Event Entry Modal */}
          {editingEventEntry && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                <h3 className="text-lg font-semibold mb-4">Edit Entry</h3>
                <form onSubmit={updateEventEntry}>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Date</label>
                      <input
                        type="date"
                        value={editEventEntryDate}
                        onChange={e => setEditEventEntryDate(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Distance (km)</label>
                      <input
                        type="number"
                        step="0.01"
                        value={editEventEntryKm}
                        onChange={e => setEditEventEntryKm(e.target.value)}
                        className="w-full border p-2 rounded"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Moving time</label>
                      <div className="grid grid-cols-3 gap-2 sm:gap-3">
                        <div className="flex flex-col">
                          <label className="block text-xs text-gray-600 mb-1 text-center">Hours</label>
                          <select 
                            value={editEventEntryTimeHours} 
                            onChange={e => handleEditEventEntryTimeHoursChange(e.target.value)}
                            className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                            required
                          >
                            {Array.from({length: 25}, (_, i) => (
                              <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                        <div className="flex flex-col">
                          <label className="block text-xs text-gray-600 mb-1 text-center">Minutes</label>
                          <select 
                            value={editEventEntryTimeMinutes} 
                            onChange={e => handleEditEventEntryTimeMinutesChange(e.target.value)}
                            className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                            required
                          >
                            {Array.from({length: 60}, (_, i) => (
                              <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                        <div className="flex flex-col">
                          <label className="block text-xs text-gray-600 mb-1 text-center">Seconds</label>
                          <select 
                            value={editEventEntryTimeSeconds} 
                            onChange={e => handleEditEventEntryTimeSecondsChange(e.target.value)}
                            className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                            required
                          >
                            {Array.from({length: 60}, (_, i) => (
                              <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                      </div>
                    </div>
                    {editEventEntryMsg && (
                      <div className="text-red-600 text-sm">{editEventEntryMsg}</div>
                    )}
                  </div>
                  <div className="flex justify-end space-x-2 mt-6">
                    <button
                      type="button"
                      onClick={closeEditEventEntryModal}
                      className="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
                    >
                      Cancel
                    </button>
                    <button
                      type="submit"
                      className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    >
                      Update Entry
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {/* Event Entry Modal */}
          {showEventEntryModal && selectedEventForEntry && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                <h3 className="text-lg font-semibold mb-4">Submit Entry - {selectedEventForEntry.name}</h3>
                <form onSubmit={submitEventEntry}>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Date</label>
                      <input
                        type="date"
                        value={eventEntryDate}
                        onChange={e => setEventEntryDate(e.target.value)}
                        className="w-full border p-2 rounded"
                        min={selectedEventForEntry.start_date}
                        max={selectedEventForEntry.end_date}
                        required
                      />
                      <div className="text-xs text-gray-500 mt-1">
                        Event period: {selectedEventForEntry.start_date} to {selectedEventForEntry.end_date}
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Distance (km)</label>
                      <input
                        type="number"
                        step="0.01"
                        min="0"
                        value={eventEntryKm}
                        onChange={e => setEventEntryKm(e.target.value)}
                        className="w-full border p-2 rounded"
                        placeholder="Enter distance"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Moving time</label>
                      <div className="grid grid-cols-3 gap-2 sm:gap-3">
                        <div className="flex flex-col">
                          <label className="block text-xs text-gray-600 mb-1 text-center">Hours</label>
                          <select 
                            value={eventEntryTimeHours} 
                            onChange={e => handleEventEntryTimeHoursChange(e.target.value)}
                            className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                            required
                          >
                            {Array.from({length: 25}, (_, i) => (
                              <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                        <div className="flex flex-col">
                          <label className="block text-xs text-gray-600 mb-1 text-center">Minutes</label>
                          <select 
                            value={eventEntryTimeMinutes} 
                            onChange={e => handleEventEntryTimeMinutesChange(e.target.value)}
                            className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                            required
                          >
                            {Array.from({length: 60}, (_, i) => (
                              <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                        <div className="flex flex-col">
                          <label className="block text-xs text-gray-600 mb-1 text-center">Seconds</label>
                          <select 
                            value={eventEntryTimeSeconds} 
                            onChange={e => handleEventEntryTimeSecondsChange(e.target.value)}
                            className="w-full border p-2 sm:p-3 rounded text-center text-sm sm:text-base font-mono bg-white"
                            required
                          >
                            {Array.from({length: 60}, (_, i) => (
                              <option key={i} value={i}>{String(i).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Screenshot (required)</label>
                      <input
                        type="file"
                        accept="image/*"
                        onChange={e => setEventEntryFile(e.target.files?.[0] || null)}
                        className="w-full border p-2 rounded"
                        required
                      />
                    </div>
                    <div className="bg-blue-50 p-3 rounded">
                      <div className="text-sm text-blue-800">
                        <strong>Event Goal:</strong> {selectedEventForEntry.km_goal} km
                      </div>
                    </div>
                    {eventEntryMsg && (
                      <div className="text-red-600 text-sm">{eventEntryMsg}</div>
                    )}
                  </div>
                  <div className="flex justify-end space-x-2 mt-6">
                    <button
                      type="button"
                      onClick={closeEventEntryModal}
                      className="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
                    >
                      Cancel
                    </button>
                    <button
                      type="submit"
                      className={`px-4 py-2 rounded ${isEventEntryTimeChanged() ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-400 text-gray-200 cursor-not-allowed'}`}
                      disabled={!isEventEntryTimeChanged()}
                    >
                      Submit Entry
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    }

    function App() {
      const { me, loading, setMe } = useMe();
      const logout = async () => { await api('/api/logout', { method: 'POST' }); setMe(null); };
      const authed = async () => { const d = await api('/api/me'); setMe(d.user); };
      if (loading) return <div className="p-6">Loading...</div>;
      if (!me) return <AuthForms onAuthed={authed} />;
      return <Dashboard onLogout={logout} isAdmin={me?.is_admin} me={me} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>


